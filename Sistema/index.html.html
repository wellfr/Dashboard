<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNvY2twaXQgRGFzaGJvYXJkIiwKICAic2hvcnRfbmFtZSI6ICJDb2NrcGl0IiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjM2I4MmY2IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFIZ0FBQUI0Q0FZQUFBQ1ROU2g5QUFBQUJITkNTVlFJQ0FnSWZBaGtpQUFBQUFsd1NGbHpBQUFBQVhOU1IwSUFyczRjNlFBQUFBUm5RVTFCQUFDeGp3djhZUVVBQUFBUWRFVllkRU5yZWtaaFlXUkJaRzlpWlNCSmJXRm5aVkpsWVdSNWNjbGxQQUFBQURoSlJFRlVlTnJ0M1E5c0UwY1l3UDh2SzBnRUtRb0VnUktCS0lFZ2dTaVJJSUVva1NDQktKRWdnU2lSSUlFb2tTQ0JLSkVnZ1NpUklJRW9rU0NCS0pFZ2dTaVJJSUVva1NDQktKRWdnU2lSSUlFb2tTQ0JLSkVnZ1NpUklJRW9rU0NCS0pFZ2dTaVJJSUVva1NDQktKRWdnU2lSSUlFb2tTQ0JLSkVnZ1NpUklJRW9rU0NCS0pFZ2dTaVJJSUVva1NDQktKRWdnU2lSSUlFb2tTQ0JLSkVnZ1NpUklJRW9rU0NCS0pFZ2dTaVJJSUVva1NDQktKRWdnU2lSSUlFb2tTQ0JLSkVnZ1NpUklJRW9rU0NCS0pFZ2dTaVJJSUVva1NDQktKRWdnU2lSSUlFb2tTQ0JLSkVnZ1NpUklJRW9rU0NCS0pFZ2dTaVJJSUVva1NDQktKRWdnU2lSSUlFb2tTQ0JLSkVnZ1NpUklJRW9rU0NCS0pFZ2dTaVJJSUVva1NDQktKRWdnU2lSSUlFb2tTQ0JLSkVnZ1NpUklJRW9rU0NCS0pFZ2dTaVJJSUVva1NDQktKRWdnU2lSSUlFb2tTQ0JLSkVnZ1NpUklJRW9rU0NCS0pFZ2dTaVJJSUVva1NDQktKRWdnU2lSSUlFb2tTQ0JLSkVnZ1NpUklJRW9rU0NCS0pFZ2dTaVJJSUVva1NDREF2ZU9YbjNaZEJRQUFBQUJKUlU1RXJrSmdnZz09IiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">
    <title>Cockpit - Investment Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #60a5fa;
            --secondary: #64748b;
            --accent: #f59e0b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --background: #ffffff;
            --surface: #f8fafc;
            --surface-light: #ffffff;
            --glass: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(226, 232, 240, 0.8);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --glow: 0 0 20px rgba(59, 130, 246, 0.3);
            --radius: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
        }

        /* Utility hidden class */
        .hidden {
            display: none !important;
        }
        
        body.dark-mode {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --primary-light: #93bbfc;
            --secondary: #94a3b8;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --glass: rgba(30, 41, 59, 0.8);
            --glass-border: rgba(51, 65, 85, 0.8);
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #64748b;
            --border: #334155;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            touch-action: manipulation;
            transition: background-color 0.3s, color 0.3s;
        }

        /* === Modern form styling === */
        .form-field label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            display: block;
            font-weight: 500;
        }
        .form-field input,
        .form-field select,
        .form-field textarea {
            width: 100%;
            padding: 0.75rem 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface-light);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        /* === Filter icon and actions styling === */
        .filter-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding-left: 0.25rem;
            display: inline-flex;
            align-items: center;
            color: var(--text-tertiary);
            transition: color 0.2s;
        }
        .filter-icon:hover {
            color: var(--primary);
        }
        .filter-icon svg {
            /* Use a smaller icon size for subtlety inside table headers */
            width: 10px;
            height: 10px;
        }
        /* Actions container inside the detail modal header */
        .modal-header .detail-actions {
            /* Position actions absolutely within the header and vertically center them */
            position: absolute;
            top: 0;
            bottom: 0;
            right: 4rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 2;
        }
        .modal-header .detail-actions .icon-button {
            /* Increase size for better visibility */
            width: 44px;
            height: 44px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .modal-header .detail-actions .icon-button:hover {
            background: var(--surface);
        }

        /* Select menu for multi-row actions */
        .select-menu {
            position: absolute;
            top: 100%;
            /* Align the dropdown menu to the right of the selection button so it doesn’t run off the page */
            right: 0;
            left: auto;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin-top: 0.25rem;
            z-index: 100;
            min-width: 180px;
            white-space: nowrap;
        }
        .select-menu.hidden {
            display: none;
        }
        .select-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: background 0.2s, color 0.2s;
        }
        .select-option:hover {
            background: var(--surface);
            color: var(--primary);
        }
        .hidden-select {
            display: none;
        }

        /* Show action icons only when hovering a table row */
        #detailTableBody .actions-cell .icon-button {
            /* Hide edit/delete buttons by default; use !important to override base styles */
            opacity: 0 !important;
            pointer-events: none !important;
            transition: opacity 0.2s ease;
        }
        #detailTableBody tr:hover .actions-cell .icon-button {
            /* Show buttons when hovering the row */
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        /* Position the multi-select actions bar in the top-right of the details view
           When placed inside the modal header, .modal-header .detail-actions will take effect (see above).
           If needed within other containers, ensure relative positioning via parent element. */

        /* === Period modal overlay === */
        .period-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            z-index: 2000;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .period-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .period-modal .modal-content {
            background: var(--surface-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 1rem 1.5rem;
            width: 90%;
            max-width: 320px;
        }
        .period-modal .modal-content h3 {
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: var(--text-primary);
        }
        .period-modal .period-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .period-modal .period-option-btn {
            width: 100%;
            padding: 0.5rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            text-align: center;
            transition: background 0.2s;
        }
        .period-modal .period-option-btn:hover {
            background: var(--surface-light);
        }

        /* === Expand button styling for receita card === */
        .kpi-header .expand-button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-tertiary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 0.25rem;
        }
        .kpi-header .expand-button:hover {
            color: var(--primary);
        }

        /* Details toggle button styling for cards (e.g., receita) */
        .kpi-header .details-toggle {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-tertiary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            margin-left: 0.25rem;
        }
        .kpi-header .details-toggle:hover {
            color: var(--primary);
        }
        
        /* Glass Morphism Effects */
        .glass {
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        
        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--surface) 0%, var(--background) 100%);
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 80%, var(--primary) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, var(--accent) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, var(--secondary) 0%, transparent 50%);
            opacity: 0.1;
            animation: gradientShift 20s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-5%, -5%) rotate(120deg); }
            66% { transform: translate(5%, -5%) rotate(240deg); }
        }
        
        .login-box {
            background: var(--surface-light);
            padding: 3rem 2rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            position: relative;
            z-index: 1;
            border: 1px solid var(--border);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .login-logo h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .login-logo p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .form-field {
            margin-bottom: 1.5rem;
        }
        
        .form-field label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .form-field input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .form-field input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .login-button {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .login-button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .security-notice {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.5;
        }
        
        .security-notice .secret-trigger {
            cursor: default;
            display: inline;
        }
        
        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
            background: var(--background);
        }
        
        /* Navigation */
        .navbar {
            background: var(--surface-light);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .navbar-brand h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .icon-button {
            background: var(--background);
            border: 1px solid var(--border);
            padding: 0.75rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
            font-size: 0;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-button:hover {
            color: var(--primary);
            border-color: var(--primary);
            background: var(--surface);
        }
        
        .theme-toggle {
            background: var(--background);
            border: 1px solid var(--border);
            padding: 0.5rem;
            border-radius: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            border-color: var(--primary);
        }
        
        .theme-toggle-icon {
            width: 20px;
            height: 20px;
            transition: all 0.3s;
        }
        
        /* Navigation Tabs - New improved navigation */
        .nav-tabs {
            background: var(--surface);
            padding: 0.5rem;
            margin: 1.5rem auto;
            max-width: 500px;
            border-radius: var(--radius-lg);
            display: flex;
            gap: 0.5rem;
            box-shadow: var(--shadow);
        }
        
        .nav-tab {
            flex: 1;
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: var(--radius);
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .nav-tab:hover {
            color: var(--primary);
            background: var(--background);
        }
        
        .nav-tab.active {
            background: var(--background);
            color: var(--primary);
            box-shadow: var(--shadow);
        }
        
        .nav-tab.active::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        /* Main Content */
        .main-content {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }
        
        .main-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
            margin-bottom: 2rem;
        }
        
        @media (min-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, 1fr);
            }
        }
        
        .kpi-card {
            background: var(--surface-light);
            border-radius: var(--radius-lg);
            padding: 1.75rem;
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            /* Allow dropdowns and menus to extend outside the card */
            overflow: visible;
            cursor: pointer;
            min-height: 180px;
        }
        
        /* Border animation on hover */
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: var(--radius-lg);
            padding: 2px;
            background: transparent;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            -webkit-mask-composite: xor;
            transition: background 0.3s;
        }
        
        .kpi-card:hover::before {
            background: linear-gradient(45deg, var(--border-color, var(--primary)) 0%, var(--border-color, var(--primary)) 40%, transparent 60%, transparent 100%);
            background-size: 300% 300%;
            animation: borderRotate 2s linear infinite;
        }
        
        @keyframes borderRotate {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        
        .kpi-card.on-track { --border-color: var(--success); }
        .kpi-card.warning { --border-color: var(--warning); }
        .kpi-card.off-track { --border-color: var(--danger); }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        /* Container for control icons (period selector and expand button) inside a KPI card header */
        .kpi-header .kpi-controls {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }
        
        .kpi-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .kpi-icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
            color: var(--primary);
        }
        
        .period-selector {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .period-selector:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1.2;
            position: relative;
            z-index: 1;
        }
        
        .kpi-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }
        
        .kpi-meta-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        
        .kpi-meta-label {
            color: var(--text-tertiary);
        }
        
        .kpi-meta-value {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .goal-message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--surface);
            border-radius: var(--radius);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 1;
        }
        
        .goal-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .goal-message.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .goal-message.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.75rem;
            position: relative;
            z-index: 1;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 4px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill.success {
            background: linear-gradient(90deg, var(--success), #22c55e);
        }
        
        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning), #f59e0b);
        }
        
        .progress-fill.danger {
            background: linear-gradient(90deg, var(--danger), #dc2626);
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: translateX(-100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }
        
        /* FAB */
        .fab-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
            z-index: 90;
        }
        
        .fab {
            width: 60px;
            height: 60px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s;
            color: white;
            position: relative;
            overflow: hidden;
            animation: fabBounce 2s ease-in-out infinite;
        }
        
        @keyframes fabBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-3px) scale(1.05); }
        }
        
        .fab::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            top: -50%;
            left: -50%;
            transform: scale(0);
            transition: transform 0.6s;
        }
        
        .fab:hover::before {
            transform: scale(1);
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            background: var(--primary-dark);
            animation: none;
        }
        
        .fab-pulse {
            animation: pulse 2s infinite, fabBounce 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            padding: 1rem;
        }
        
        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background: var(--surface-light);
            border-radius: var(--radius-xl);
            padding: 2rem;
            max-width: 100%;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            animation: slideUp 0.3s ease-out;
        }
        
        @media (min-width: 640px) {
            .modal-content {
                max-width: 600px;
            }
        }
        
        .modal-content.large {
            max-width: 90%;
            max-height: 90vh;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        /* Detail Modal */
        .detail-content {
            margin-top: 1.5rem;
        }
        
        .detail-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .detail-table th {
            text-align: left;
            padding: 0.75rem;
            background: var(--surface);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
        }
        
        .detail-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .detail-table tr:hover {
            background: var(--surface);
        }
        
        .detail-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 0.5rem 1rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
        }
        
        /* Date Range Picker - Fixed */
        .date-range-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
            padding: 0.75rem;
            background: var(--surface);
            border-radius: var(--radius);
            margin-top: 0.5rem;
        }
        
        .date-input {
            padding: 0.5rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 16px; /* Prevents zoom on mobile */
            -webkit-appearance: none;
        }
        
        /* NPS Badge */
        .nps-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background: var(--success);
            color: white;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Insights Section */
        .insights-container {
            background: var(--surface-light);
            border-radius: var(--radius-lg);
            padding: 1.75rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }
        
        .insights-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .insights-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .insight-item {
            background: var(--background);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            transition: all 0.3s;
        }
        
        .insight-item:hover {
            transform: translateX(4px);
            border-color: var(--primary);
        }
        
        .insight-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        
        .insight-icon.positive { color: var(--success); }
        .insight-icon.warning { color: var(--warning); }
        .insight-icon.negative { color: var(--danger); }
        
        .insight-content {
            flex: 1;
        }
        
        .insight-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* Pipeline Section */
        .pipeline-section {
            background: var(--surface-light);
            border-radius: var(--radius-lg);
            padding: 1.75rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }
        
        .pipeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        
        .pipeline-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .pipeline-search {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            color: var(--text-primary);
        }
        
        .pipeline-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .pipeline-table th {
            text-align: left;
            padding: 0.75rem;
            background: var(--surface);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
        }
        
        .pipeline-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 0.875rem;
            vertical-align: middle;
        }
        
        .pipeline-table tr:hover {
            background: var(--surface);
        }
        
        .pipeline-table .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-button {
            padding: 0.25rem 0.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .action-button:hover {
            background: var(--primary-dark);
        }
        
        .action-button.secondary {
            background: var(--secondary);
        }
        
        .action-button.secondary:hover {
            background: var(--secondary);
            opacity: 0.8;
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .status-icon {
            width: 16px;
            height: 16px;
            margin-right: 0.25rem;
        }
        
        .status-icon.warning {
            color: var(--warning);
        }
        
        .status-icon.danger {
            color: var(--danger);
        }
        
        /* Chart Container */
        .chart-button-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .show-chart-button {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .show-chart-button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
            margin-bottom: 2rem;
        }
        
        @media (min-width: 640px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            padding: 1rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s;
            min-height: 48px;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-input.currency {
            text-align: right;
        }
        
        .form-input.percentage::after {
            content: '%';
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border);
            transition: all 0.3s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: all 0.3s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background: var(--primary);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 1.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 48px;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--surface);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        /* Button Group */
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        /* Settings Sections - Collapsible */
        .settings-section {
            margin-bottom: 2rem;
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .settings-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            padding: 1.25rem 1.75rem;
            background: var(--surface-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.3s;
            margin: 0;
        }
        
        .settings-title:hover {
            background: var(--surface);
        }
        
        .settings-content {
            padding: 1.75rem;
            display: none;
        }
        
        .settings-section.active .settings-content {
            display: block;
        }
        
        .settings-title .toggle-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s;
        }
        
        .settings-section.active .toggle-icon {
            transform: rotate(180deg);
        }
        
        .add-button {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .add-button:hover {
            transform: rotate(90deg) scale(1.1);
            background: var(--primary-dark);
        }
        
        .user-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--background);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .user-role {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        
        .meta-item {
            padding: 1rem;
            background: var(--background);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 0.75rem;
        }
        
        .meta-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .meta-item-title {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .meta-item-value {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .meta-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }
        
        .meta-detail {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        
        /* API Section */
        .api-section {
            background: var(--background);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .api-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        
        .api-step {
            margin-bottom: 1.5rem;
        }
        
        .api-step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .api-step-content {
            margin-left: 2rem;
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .code-block {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            overflow-x: auto;
        }
        
        /* Chart Modal */
        .chart-config {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        .chart-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chart-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .chart-option label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        /* Period Dropdown - now positioned fixed relative to viewport */
        .period-dropdown {
            position: fixed;
            /* top and left will be set dynamically in JS when opened */
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            display: none;
            /* High z-index to ensure the dropdown appears above cards and other content */
            z-index: 9999;
            min-width: 200px;
            padding: 0.5rem 0;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Hide per-card period dropdowns; global dropdown is used instead */
        .period-dropdown:not(#globalPeriodDropdown) {
            display: none !important;
        }
        
        .period-dropdown.show {
            display: block;
        }
        
        .period-option {
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .period-option:hover {
            background: var(--surface);
            color: var(--primary);
        }
        
        .period-option.active {
            color: var(--primary);
            font-weight: 500;
            background: var(--surface);
        }

        /* Filter dropdown used for column filtering */
        .filter-dropdown {
            position: absolute;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            min-width: 160px;
            max-height: 250px;
            overflow-y: auto;
            padding: 0.25rem 0;
        }
        .filter-dropdown .filter-title {
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            font-size: 0.7rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }
        .filter-dropdown .filter-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: background 0.2s, color 0.2s;
        }
        .filter-dropdown .filter-option:hover {
            background: var(--surface);
            color: var(--primary);
        }
        .filter-dropdown .filter-input {
            width: calc(100% - 1.5rem);
            margin: 0.25rem 0.75rem;
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.8rem;
            color: var(--text-primary);
            background: var(--surface-light);
        }

        
        .period-divider {
            height: 1px;
            background: var(--border);
            margin: 0.5rem 0;
        }
        
        .period-custom {
            padding: 0.75rem 1rem;
        }
        
        .period-custom .btn {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            min-height: 36px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: var(--surface);
        }
        
        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: var(--text-tertiary);
        }
        
        .upload-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .upload-hint {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .toast {
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.error {
            border-left: 4px solid var(--danger);
        }
        
        .toast.warning {
            border-left: 4px solid var(--warning);
        }
        
        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0.25rem;
        }
        
        .toast-close:hover {
            color: var(--text-primary);
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--surface-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--surface);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
        
        /* Android/Samsung Optimizations */
        @media (max-width: 768px) {
            .kpi-value {
                font-size: 1.75rem;
            }
            
            .modal-content {
                padding: 1.5rem;
            }
            
            .form-input,
            .form-select,
            .form-textarea,
            .date-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .navbar {
                padding: 0.75rem 1rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .kpi-card {
                padding: 1.25rem;
            }
            
            .nav-tabs {
                margin: 1rem auto;
            }
        }
        
        /* User Edit Modal specific z-index - Fixed */
        #userEditModal {
            z-index: 1100;
        }
        
        /* Activity Choice Modal styles */
        .choice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .choice-card {
            background: var(--surface-light);
            border-radius: var(--radius-lg);
            padding: 2rem 1.5rem;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .choice-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }
        
        .choice-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
        }
        
        .choice-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .choice-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-logo">
                <h1>Cockpit</h1>
                <p>Investment Performance Dashboard</p>
            </div>
            <form class="login-form" id="loginForm">
                <div class="form-field">
                    <label for="email">Email corporativo</label>
                    <input type="email" id="email" placeholder="seu@email.com" required autocomplete="email">
                </div>
                <div class="form-field">
                    <label for="password">Senha</label>
                    <input type="password" id="password" placeholder="••••••••" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-button">
                    Acessar Dashboard
                </button>
            </form>
            <div class="security-notice">
                <p>O acesso ao sistema é restrito aos usuários autorizados. Este sistema está em conformidade com a LGPD e todas as informações são <span class="secret-trigger" onclick="secretAccess()">confidenciai<span style="cursor: pointer;">s</span></span>.</p>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="app-container" id="mainApp">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="navbar-content">
                <div class="navbar-brand">
                    <h1>Cockpit</h1>
                </div>
                <div class="navbar-actions">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                        <svg class="theme-toggle-icon" id="lightIcon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <svg class="theme-toggle-icon hidden" id="darkIcon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </button>
                    <button class="icon-button" onclick="showSettings()" title="Configurações">
                        <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                    <button class="icon-button" onclick="logout()" title="Sair">
                        <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">
                <svg class="icon" style="margin-right: 0.5rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                Dashboard
            </button>
            <button class="nav-tab" onclick="switchTab('pipeline')">
                <svg class="icon" style="margin-right: 0.5rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                Pipeline
            </button>
        </div>
        
        <!-- Dashboard Content -->
        <div class="main-content active" id="dashboardContent">
            <!-- Insights Section -->
            <div class="insights-container" id="insightsContainer">
                <div class="insights-header">
                    <svg class="icon" style="color: var(--primary)" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <h2 class="insights-title">Insights Inteligentes</h2>
                </div>
                <div id="insightsList">
                    <!-- Insights serão inseridos dinamicamente -->
                </div>
            </div>
            
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <!-- Captação Total -->
                <div class="kpi-card" id="captacaoCard" onclick="onCardClick(event, 'captacao')">
                    <div class="kpi-header">
                        <div class="kpi-title">
                            <svg class="kpi-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Captação Total
                        </div>
                        <div class="kpi-controls">
                            <!-- Seletor de período -->
                            <button class="period-selector" onclick="togglePeriodDropdown(event, 'captacao')" title="Selecionar Período">
                                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </button>
                            <div class="period-dropdown" id="captacao-period-dropdown">
                                <div class="period-option" onclick="selectPeriod('captacao', 'day')">Dia</div>
                                <div class="period-option" onclick="selectPeriod('captacao', 'week')">Semana</div>
                                <div class="period-option active" onclick="selectPeriod('captacao', 'month')">Mês</div>
                                <div class="period-option" onclick="selectPeriod('captacao', 'quarter')">Trimestre</div>
                                <div class="period-option" onclick="selectPeriod('captacao', 'semester')">Semestre</div>
                                <div class="period-divider"></div>
                                <div class="period-option" onclick="selectCustomPeriod('captacao')">Período Personalizado</div>
                                <div class="period-custom hidden" id="captacao-custom">
                                    <div class="date-range-container">
                                        <input type="date" class="date-input" id="captacao-start">
                                        <span style="margin: 0 0.5rem;">até</span>
                                        <input type="date" class="date-input" id="captacao-end">
                                    </div>
                                    <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;" onclick="applyCustomPeriod('captacao')">Aplicar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="kpi-value" id="captacaoValue">R$ 0</div>
                    <div class="kpi-meta">
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Meta:</span>
                            <span class="kpi-meta-value" id="captacaoMetaDisplay">R$ 500.000</span>
                        </div>
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Período:</span>
                            <span class="kpi-meta-value" id="captacaoPeriod">Mensal</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="captacaoProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="goal-message" id="captacaoGoalMessage" style="display: none;"></div>
                </div>
                
                <!-- Receita -->
                <div class="kpi-card" id="receitaCard" onclick="onCardClick(event, 'receita')">
                    <div class="kpi-header">
                        <div class="kpi-title">
                            <svg class="kpi-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            Receita Total
                        </div>
                        <div class="kpi-controls">
                            <!-- Botão para expandir detalhamento por classes de ativo -->
                            <button class="expand-button" onclick="toggleReceitaBreakdown(event)" title="Expandir Receita por Classe">
                                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <!-- Ícone customizado: símbolo de mais para expansão -->
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m-7-7h14" />
                                </svg>
                            </button>
                            <!-- Selector de período (calendário) -->
                            <button class="period-selector" onclick="togglePeriodDropdown(event, 'receita')" title="Selecionar Período">
                                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </button>
                            <div class="period-dropdown" id="receita-period-dropdown">
                                <div class="period-option" onclick="selectPeriod('receita', 'day')">Dia</div>
                                <div class="period-option" onclick="selectPeriod('receita', 'week')">Semana</div>
                                <div class="period-option active" onclick="selectPeriod('receita', 'month')">Mês</div>
                                <div class="period-option" onclick="selectPeriod('receita', 'quarter')">Trimestre</div>
                                <div class="period-option" onclick="selectPeriod('receita', 'semester')">Semestre</div>
                                <div class="period-divider"></div>
                                <div class="period-option" onclick="selectCustomPeriod('receita')">Período Personalizado</div>
                                <div class="period-custom hidden" id="receita-custom">
                                    <div class="date-range-container">
                                        <input type="date" class="date-input" id="receita-start">
                                        <span style="margin: 0 0.5rem;">até</span>
                                        <input type="date" class="date-input" id="receita-end">
                                    </div>
                                    <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;" onclick="applyCustomPeriod('receita')">Aplicar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="kpi-value" id="receitaValue">R$ 0</div>
                    <div class="kpi-meta" id="receitaMeta">
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Meta:</span>
                            <span class="kpi-meta-value" id="receitaMetaDisplay">R$ 50.000</span>
                        </div>
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Período:</span>
                            <span class="kpi-meta-value" id="receitaPeriod">Mensal</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="receitaProgressBar" style="width: 0%"></div>
                    </div>
                    <!-- Container para mostrar distribuição de receita por classe de ativo -->
                    <div id="receitaBreakdown" class="kpi-meta hidden" style="margin-top: 0.5rem;"></div>
                    <div class="goal-message" id="receitaGoalMessage" style="display: none;"></div>
                </div>
                
                <!-- Contatos -->
                <div class="kpi-card" id="contatosCard" onclick="onCardClick(event, 'contatos')">
                    <div class="kpi-header">
                        <div class="kpi-title">
                            <svg class="kpi-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                            Contatos Realizados
                        </div>
                        <div class="kpi-controls">
                            <button class="period-selector" onclick="togglePeriodDropdown(event, 'contatos')" title="Selecionar Período">
                                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </button>
                            <div class="period-dropdown" id="contatos-period-dropdown">
                                <div class="period-option" onclick="selectPeriod('contatos', 'day')">Dia</div>
                                <div class="period-option" onclick="selectPeriod('contatos', 'week')">Semana</div>
                                <div class="period-option active" onclick="selectPeriod('contatos', 'month')">Mês</div>
                                <div class="period-option" onclick="selectPeriod('contatos', 'quarter')">Trimestre</div>
                                <div class="period-option" onclick="selectPeriod('contatos', 'semester')">Semestre</div>
                                <div class="period-divider"></div>
                                <div class="period-option" onclick="selectCustomPeriod('contatos')">Período Personalizado</div>
                                <div class="period-custom hidden" id="contatos-custom">
                                    <div class="date-range-container">
                                        <input type="date" class="date-input" id="contatos-start">
                                        <span style="margin: 0 0.5rem;">até</span>
                                        <input type="date" class="date-input" id="contatos-end">
                                    </div>
                                    <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;" onclick="applyCustomPeriod('contatos')">Aplicar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="kpi-value" id="contatosValue">0</div>
                    <div class="kpi-meta">
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Relacionamento:</span>
                            <span class="kpi-meta-value" id="contatosRel">0</span>
                        </div>
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Prospecção:</span>
                            <span class="kpi-meta-value" id="contatosProsp">0</span>
                        </div>
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Meta diária:</span>
                            <span class="kpi-meta-value" id="contatosMetaDisplay">10</span>
                        </div>
                    </div>
                    <div class="goal-message" id="contatosGoalMessage" style="display: none;"></div>
                </div>
                
                <!-- Taxa de Conversão -->
                <div class="kpi-card" id="conversaoCard" onclick="onCardClick(event, 'conversao')">
                    <div class="kpi-header">
                        <div class="kpi-title">
                            <svg class="kpi-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                            Taxa de Conversão
                        </div>
                        <div class="kpi-controls">
                            <button class="period-selector" onclick="togglePeriodDropdown(event, 'conversao')" title="Selecionar Período">
                                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </button>
                            <div class="period-dropdown" id="conversao-period-dropdown">
                                <div class="period-option" onclick="selectPeriod('conversao', 'day')">Dia</div>
                                <div class="period-option" onclick="selectPeriod('conversao', 'week')">Semana</div>
                                <div class="period-option active" onclick="selectPeriod('conversao', 'month')">Mês</div>
                                <div class="period-option" onclick="selectPeriod('conversao', 'quarter')">Trimestre</div>
                                <div class="period-option" onclick="selectPeriod('conversao', 'semester')">Semestre</div>
                                <div class="period-divider"></div>
                                <div class="period-option" onclick="selectCustomPeriod('conversao')">Período Personalizado</div>
                                <div class="period-custom hidden" id="conversao-custom">
                                    <div class="date-range-container">
                                        <input type="date" class="date-input" id="conversao-start">
                                        <span style="margin: 0 0.5rem;">até</span>
                                        <input type="date" class="date-input" id="conversao-end">
                                    </div>
                                    <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;" onclick="applyCustomPeriod('conversao')">Aplicar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="kpi-value" id="conversaoValue">0%</div>
                    <div class="kpi-meta">
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Negócios:</span>
                            <span class="kpi-meta-value" id="totalNegocios">0</span>
                        </div>
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Meta mensal:</span>
                            <span class="kpi-meta-value" id="conversaoMetaDisplay">15%</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="conversaoProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- NPS -->
                <div class="kpi-card" id="npsCard" onclick="onCardClick(event, 'nps')">
                    <div class="kpi-header">
                        <div class="kpi-title">
                            <svg class="kpi-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                            </svg>
                            NPS & Pesquisas
                        </div>
                        <div class="kpi-controls">
                            <button class="period-selector" onclick="togglePeriodDropdown(event, 'nps')" title="Selecionar Período">
                                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </button>
                            <div class="period-dropdown" id="nps-period-dropdown">
                                <div class="period-option" onclick="selectPeriod('nps', 'day')">Dia</div>
                                <div class="period-option" onclick="selectPeriod('nps', 'week')">Semana</div>
                                <div class="period-option active" onclick="selectPeriod('nps', 'month')">Mês</div>
                                <div class="period-option" onclick="selectPeriod('nps', 'quarter')">Trimestre</div>
                                <div class="period-option" onclick="selectPeriod('nps', 'semester')">Semestre</div>
                                <div class="period-divider"></div>
                                <div class="period-option" onclick="selectCustomPeriod('nps')">Período Personalizado</div>
                                <div class="period-custom hidden" id="nps-custom">
                                    <div class="date-range-container">
                                        <input type="date" class="date-input" id="nps-start">
                                        <span style="margin: 0 0.5rem;">até</span>
                                        <input type="date" class="date-input" id="nps-end">
                                    </div>
                                    <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;" onclick="applyCustomPeriod('nps')">Aplicar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="kpi-value" id="npsValue">0</div>
                    <div class="kpi-meta">
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Clientes aptos:</span>
                            <span class="kpi-meta-value" id="clientesAptos">0</span>
                        </div>
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Meta NPS:</span>
                            <span class="kpi-meta-value" id="npsMetaDisplay">70</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="npsProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Atividades Programadas -->
                <div class="kpi-card" id="atividadesCard" onclick="showDetails('atividades')">
                    <div class="kpi-header">
                        <div class="kpi-title">
                            <svg class="kpi-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Atividades Programadas
                        </div>
                    </div>
                    <div class="kpi-value" id="atividadesValue">0</div>
                    <div class="kpi-meta">
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Hoje:</span>
                            <span class="kpi-meta-value" id="atividadesHoje">0</span>
                        </div>
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Esta semana:</span>
                            <span class="kpi-meta-value" id="atividadesSemana">0</span>
                        </div>
                        <div class="kpi-meta-item">
                            <span class="kpi-meta-label">Atrasadas:</span>
                            <span class="kpi-meta-value" id="atividadesAtrasadas" style="color: var(--danger);">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart Button -->
            <div class="chart-button-container">
                <button class="show-chart-button" onclick="showChartModal()">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Visualizar Gráficos
                </button>
            </div>

            <!-- Global Period Dropdown and Custom Range Panel -->
            <!-- This detached container allows period selectors to display dropdowns above all cards, avoiding stacking context issues. -->
            <div id="globalPeriodDropdown" class="period-dropdown" style="display: none;">
                <!-- Dynamic period options will be injected here via JavaScript. -->
            </div>
        </div>
        
        <!-- Pipeline Content -->
        <div class="main-content" id="pipelineContent">
            <div class="pipeline-section">
                <div class="pipeline-header">
                    <h2 class="pipeline-title">Pipeline de Oportunidades</h2>
                    <button class="add-button" onclick="showPipelineForm()">
                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="pipeline-search">
                    <input type="text" class="search-input" id="pipelineSearch" placeholder="Pesquisar por ID, estratégia ou gerente..." onkeyup="filterPipeline()">
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="pipeline-table">
                        <thead>
                            <tr>
                                <th>Primeiro Contato</th>
                                <th>ID Cliente</th>
                                <th>Origem</th>
                                <th>Estratégia</th>
                                <th>Valor Potencial</th>
                                <th>Indicação</th>
                                <th>Dias sem Contato</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="pipelineTableBody">
                            <!-- Pipeline items serão inseridos dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- FAB Container -->
        <div class="fab-container">
            <button class="fab fab-pulse" onclick="showActivityChoice()" title="Cadastrar Atividade">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>
        
        <!-- Hidden File Input -->
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
    </div>
    
    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content large">
            <div class="modal-header">
                <!-- Container for actions (multi-select, duplicate, delete) -->
                <div id="detailActions" class="detail-actions"></div>
                <!-- Title of the detail modal -->
                <h2 class="modal-title" id="detailModalTitle">Detalhes</h2>
                <!-- Close button for the detail modal -->
                <button class="icon-button" onclick="closeModal('detailModal')">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="detail-filters" id="detailFilters">
                <!-- Filtros serão inseridos dinamicamente -->
            </div>
            
            <div class="detail-content">
                <table class="detail-table" id="detailTable">
                    <thead id="detailTableHead">
                        <!-- Cabeçalhos serão inseridos dinamicamente -->
                    </thead>
                    <tbody id="detailTableBody">
                        <!-- Dados serão inseridos dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Activity Choice Modal -->
    <div class="modal" id="activityChoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">O que você deseja registrar?</h2>
                <button class="icon-button" onclick="closeModal('activityChoiceModal')">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="choice-grid">
                <div class="choice-card" onclick="showActivityForm()">
                    <svg class="choice-icon" style="color: var(--primary);" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    <h3 class="choice-title">Registrar Atividade</h3>
                    <p class="choice-description">Adicione um novo contato realizado</p>
                </div>
                
                <div class="choice-card" onclick="showPipelineForm()">
                    <svg class="choice-icon" style="color: var(--accent);" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <h3 class="choice-title">Registrar Pipeline</h3>
                    <p class="choice-description">Adicione uma nova oportunidade</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Activity Form Modal -->
    <div class="modal" id="activityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Registrar Atividade</h2>
                <button class="icon-button" onclick="closeModal('activityModal')">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form class="form-grid" id="activityForm">
                <div class="form-group">
                    <label class="form-label">Data do Contato</label>
                    <input type="date" class="form-input" id="dataContato" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Hora do Contato</label>
                    <input type="time" class="form-input" id="horaContato" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ID do Cliente</label>
                    <input type="text" class="form-input" id="idCliente" placeholder="CLI001" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo de Atividade</label>
                    <select class="form-select" id="tipoAtividade" required>
                        <option value="">Selecione...</option>
                        <option value="prospeccao">Prospecção</option>
                        <option value="relacionamento">Relacionamento</option>
                        <option value="retencao">Retenção</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Canal</label>
                    <select class="form-select" id="canal" required>
                        <option value="">Selecione...</option>
                        <option value="ligacao">Ligação</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="email">E-mail</option>
                        <option value="videochamada">Videochamada</option>
                        <option value="presencial">Reunião Presencial</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Origem</label>
                    <select class="form-select" id="origem" onchange="checkOrigemFields()" required>
                        <option value="">Selecione...</option>
                        <option value="base">Base</option>
                        <option value="indicacao_base">Indicação da Base</option>
                        <option value="indicacao_ecossistema">Indicação do Ecossistema</option>
                    </select>
                </div>
                
                <div class="form-group origem-fields gerente-field hidden">
                    <label class="form-label">Gerente Indicador</label>
                    <input type="text" class="form-input" id="gerenteIndicador" placeholder="Nome do gerente">
                </div>
                
                <div class="form-group origem-fields cliente-field hidden">
                    <label class="form-label">ID Cliente Indicador</label>
                    <input type="text" class="form-input" id="clienteIndicador" placeholder="CLI000">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Gerou Movimentação Financeira?</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="gerouVolume" onchange="toggleVolumeFields()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Flag para indicar se a atividade foi bem sucedida -->
                <div class="form-group">
                    <label class="form-label">Atividade foi bem sucedida?</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="atividadeSucesso">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="form-group volume-fields hidden">
                    <label class="form-label">Estratégia</label>
                    <select class="form-select" id="estrategia">
                        <option value="">Selecione...</option>
                        <option value="principalidade">Principalidade</option>
                        <option value="transacionalidade">Transacionalidade</option>
                        <option value="saldo_conta">Saldo em Conta Corrente</option>
                        <option value="previdencia_stvm">Previdência/STVM</option>
                    </select>
                </div>
                
                <div class="form-group volume-fields hidden">
                    <label class="form-label">Valor (R$)</label>
                    <input type="text" class="form-input currency" id="valor" placeholder="0,00" onkeyup="formatCurrencyInput(this)">
                </div>
                
                <div class="form-group volume-fields hidden">
                    <label class="form-label">Produto</label>
                    <select class="form-select" id="produto" onchange="calculateCommission()">
                        <option value="">Selecione...</option>
                        <option value="rf_bancarios">Renda Fixa Bancários</option>
                        <option value="rf_bancarios_toro">Renda Fixa Bancários Toro</option>
                        <option value="credito_privado">Crédito Privado</option>
                        <option value="credito_privado_toro">Crédito Privado Toro</option>
                        <option value="fundos">Fundos de Investimentos</option>
                        <option value="coe">COE</option>
                        <option value="previdencia">Previdência</option>
                        <option value="renda_variavel">Renda Variável</option>
                    </select>
                </div>
                
                <div class="form-group volume-fields hidden">
                    <label class="form-label">Comissão TAF (%)</label>
                    <input type="text" class="form-input" id="comissaoTAF" placeholder="0" onchange="calculateROA()" onkeyup="formatPercentageInput(this)">
                </div>
                
                <div class="form-group volume-fields hidden">
                    <label class="form-label">Repasse ROA (R$)</label>
                    <input type="text" class="form-input currency" id="repasseROA" placeholder="0,00" readonly>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Observações</label>
                    <textarea class="form-textarea" id="descricao" rows="3" placeholder="Descreva a atividade..."></textarea>
                </div>
            </form>
            
            <div class="button-group">
                <button class="btn" onclick="saveData()">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    Salvar
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click();">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Upload Excel
                </button>
                <button class="btn btn-secondary" onclick="downloadTemplate()">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Template
                </button>
            </div>
        </div>
    </div>
    
    <!-- Pipeline Form Modal -->
    <div class="modal" id="pipelineModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Registrar Oportunidade</h2>
                <button class="icon-button" onclick="closeModal('pipelineModal')">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form class="form-grid" id="pipelineForm">
                <div class="form-group">
                    <label class="form-label">Data do Primeiro Contato</label>
                    <input type="date" class="form-input" id="pipelineDataContato" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ID do Cliente</label>
                    <input type="text" class="form-input" id="pipelineIdCliente" placeholder="CLI001" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Origem</label>
                    <select class="form-select" id="pipelineOrigem" onchange="checkPipelineOrigemFields()" required>
                        <option value="">Selecione...</option>
                        <option value="base">Base</option>
                        <option value="indicacao_base">Indicação da Base</option>
                        <option value="indicacao_ecossistema">Indicação do Ecossistema</option>
                    </select>
                </div>
                
                <div class="form-group pipeline-origem-fields gerente-field hidden">
                    <label class="form-label">Gerente Indicador</label>
                    <input type="text" class="form-input" id="pipelineGerenteIndicador" placeholder="Nome do gerente">
                </div>
                
                <div class="form-group pipeline-origem-fields cliente-field hidden">
                    <label class="form-label">ID Cliente Indicador</label>
                    <input type="text" class="form-input" id="pipelineClienteIndicador" placeholder="CLI000">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estratégia</label>
                    <select class="form-select" id="pipelineEstrategia" required>
                        <option value="">Selecione...</option>
                        <option value="principalidade">Principalidade</option>
                        <option value="transacionalidade">Transacionalidade</option>
                        <option value="saldo_conta">Saldo em Conta Corrente</option>
                        <option value="previdencia_stvm">Previdência/STVM</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Valor Potencial (R$)</label>
                    <input type="text" class="form-input currency" id="pipelineValor" placeholder="0,00" onkeyup="formatCurrencyInput(this)" required>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Observações</label>
                    <textarea class="form-textarea" id="pipelineObservacoes" rows="3" placeholder="Descreva a oportunidade..."></textarea>
                </div>
            </form>
            
            <div class="button-group">
                <button class="btn" onclick="savePipeline()">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    Salvar
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click();">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Upload Excel
                </button>
            </div>
        </div>
    </div>
    
    <!-- User Edit Modal -->
    <div class="modal" id="userEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Editar Usuário</h2>
                <button class="icon-button" onclick="closeModal('userEditModal')">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form class="form-grid" id="userEditForm">
                <input type="hidden" id="editUserId">
                
                <div class="form-group full-width">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-input" id="editUserName" required>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="editUserEmail" required>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Nova Senha (deixe em branco para manter a atual)</label>
                    <input type="password" class="form-input" id="editUserPassword">
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Tipo de Usuário</label>
                    <select class="form-select" id="editUserRole">
                        <option value="User">Usuário</option>
                        <option value="Admin">Administrador</option>
                        <option value="Master">Master</option>
                    </select>
                </div>
            </form>
            
            <div class="button-group" style="justify-content: flex-end; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="closeModal('userEditModal')">Cancelar</button>
                <button class="btn" onclick="saveUserEdit()">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Configurações</h2>
                <button class="icon-button" onclick="closeModal('settingsModal')">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Controle de Usuários -->
            <div class="settings-section" id="usersSection">
                <div class="settings-title" onclick="toggleSettingsSection('usersSection')">
                    <span>Controle de Usuários</span>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button class="add-button" onclick="event.stopPropagation(); addUser()">
                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                        <svg class="toggle-icon" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
                <div class="settings-content">
                    <div class="user-list" id="userList">
                        <!-- Usuários serão listados aqui -->
                    </div>
                </div>
            </div>
            
            <!-- Metas -->
            <div class="settings-section" id="metasSection">
                <div class="settings-title" onclick="toggleSettingsSection('metasSection')">
                    <span>Metas</span>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button class="add-button" onclick="event.stopPropagation(); showMetasForm()">
                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                        <svg class="toggle-icon" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
                <div class="settings-content">
                    <div id="metasList">
                        <!-- Metas serão listadas aqui -->
                    </div>
                </div>
            </div>
            
            <!-- Integração API -->
            <div class="settings-section" id="apiSection">
                <div class="settings-title" onclick="toggleSettingsSection('apiSection')">
                    <span>Integração API</span>
                    <svg class="toggle-icon" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div class="settings-content">
                    <div class="api-section">
                        <div class="api-title">Excel Online / Google Sheets</div>
                        
                        <div class="api-step">
                            <span class="api-step-number">1</span>
                            <strong>Configuração do Google Sheets</strong>
                            <div class="api-step-content">
                                <p>Acesse o Google Cloud Console e crie um novo projeto ou selecione um existente.</p>
                                <p>Ative a API do Google Sheets e crie credenciais de serviço.</p>
                            </div>
                        </div>
                        
                        <div class="api-step">
                            <span class="api-step-number">2</span>
                            <strong>Chave da API</strong>
                            <div class="api-step-content">
                                <input type="text" class="form-input" placeholder="Cole aqui sua chave de API" id="apiKey">
                                <div class="code-block">
                                    // Exemplo de configuração
                                    const API_KEY = 'sua-chave-aqui';
                                    const SPREADSHEET_ID = 'id-da-planilha';
                                </div>
                            </div>
                        </div>
                        
                        <div class="api-step">
                            <span class="api-step-number">3</span>
                            <strong>URL da Planilha</strong>
                            <div class="api-step-content">
                                <input type="text" class="form-input" placeholder="https://docs.google.com/spreadsheets/d/..." id="sheetUrl">
                                <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-tertiary);">
                                    Certifique-se de que a planilha está compartilhada com permissão de leitura.
                                </p>
                            </div>
                        </div>
                        
                        <div class="api-step">
                            <span class="api-step-number">4</span>
                            <strong>Sincronização Automática</strong>
                            <div class="api-step-content">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoSync">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span style="margin-left: 1rem;">Atualizar a cada 5 minutos</span>
                            </div>
                        </div>
                        
                        <button class="btn" onclick="testAPIConnection()" style="margin-top: 1rem;">
                            <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Testar Conexão
                        </button>
                    </div>
                </div>
            </div>
            
            <button class="btn" onclick="saveSettings()" style="margin-top: 2rem;">
                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                </svg>
                Salvar Configurações
            </button>
        </div>
    </div>
    
    <!-- Metas Form Modal -->
    <div class="modal" id="metasFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Configurar Metas</h2>
                <button class="icon-button" onclick="closeModal('metasFormModal')">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form class="form-grid" id="metasForm">
                <div class="form-group full-width">
                    <label class="form-label">Captação Semestral (R$)</label>
                    <input type="text" class="form-input currency" id="metaCaptacaoSemestral" placeholder="3.000.000,00" onkeyup="formatCurrencyInput(this)">
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Receita Semestral Total (R$)</label>
                    <input type="text" class="form-input currency" id="metaReceitaSemestral" placeholder="300.000,00" onkeyup="formatCurrencyInput(this)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Meta COE (R$)</label>
                    <input type="text" class="form-input currency" id="metaCOE" placeholder="50.000,00" onkeyup="formatCurrencyInput(this)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Meta Previdência (R$)</label>
                    <input type="text" class="form-input currency" id="metaPrevidencia" placeholder="100.000,00" onkeyup="formatCurrencyInput(this)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Meta Renda Fixa Bancários (R$)</label>
                    <input type="text" class="form-input currency" id="metaRF" placeholder="80.000,00" onkeyup="formatCurrencyInput(this)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Meta Crédito Privado (R$)</label>
                    <input type="text" class="form-input currency" id="metaCP" placeholder="40.000,00" onkeyup="formatCurrencyInput(this)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Meta Fundos de Investimento (R$)</label>
                    <input type="text" class="form-input currency" id="metaFundos" placeholder="30.000,00" onkeyup="formatCurrencyInput(this)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Contatos por Dia</label>
                    <input type="number" class="form-input" id="metaContatosDia" placeholder="10">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Taxa de Conversão Mensal (%)</label>
                    <input type="text" class="form-input" id="metaConversao" placeholder="15,0" onkeyup="formatPercentageInput(this)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Meta NPS</label>
                    <input type="number" class="form-input" id="metaNPS" placeholder="70">
                </div>
            </form>
            
            <button class="btn" onclick="saveMetas()">
                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                </svg>
                Salvar Metas
            </button>
        </div>
    </div>
    
    <!-- Chart Modal -->
    <div class="modal" id="chartModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 class="modal-title">Análise de Performance</h2>
                <button class="icon-button" onclick="closeModal('chartModal')">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="chart-config">
                <div style="font-weight: 500; margin-bottom: 0.5rem;">Selecione os indicadores:</div>
                <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                    <div class="chart-option">
                        <input type="checkbox" id="chartCaptacao" checked>
                        <label for="chartCaptacao">Captação</label>
                    </div>
                    <div class="chart-option">
                        <input type="checkbox" id="chartContatos" checked>
                        <label for="chartContatos">Contatos</label>
                    </div>
                    <div class="chart-option">
                        <input type="checkbox" id="chartConversao">
                        <label for="chartConversao">Taxa de Conversão</label>
                    </div>
                    <div class="chart-option">
                        <input type="checkbox" id="chartReceita">
                        <label for="chartReceita">Receita</label>
                    </div>
                    <button class="btn btn-secondary" onclick="updateChart()">Atualizar Gráfico</button>
                </div>
            </div>
            
            <div style="height: 400px; margin-top: 2rem;">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // App State
        let dashboardData = [];
        let pipelineData = [];
        let scheduledActivities = [];
        // Global variables for detail filters and selection mode
        let detailFilters = {};
        let selectionMode = false;
        // Track which details view is currently open for refreshing after edits/deletes
        let currentDetailType = null;
        // Track record being edited (null for new records)
        let editingId = null;
        // Keep track of current table headers for filtering and sorting
        let currentHeaders = [];
        let settings = {
            users: [
                { id: 1, name: 'Administrador', email: 'admin@cockpit.com', role: 'Master', password: btoa('admin123') }
            ],
            metas: {
                captacaoSemestral: 3000000,
                receitaSemestral: 300000,
                coe: 50000,
                previdencia: 100000,
                rf: 80000,
                cp: 40000,
                fundos: 30000,
                contatosDia: 10,
                conversaoMensal: 15,
                nps: 70
            },
            api: {
                key: '',
                sheetUrl: '',
                autoSync: false
            }
        };
        let performanceChart = null;
        let cardPeriods = {
            captacao: 'month',
            contatos: 'month',
            conversao: 'month',
            nps: 'month',
            receita: 'month'
        };
        let customPeriods = {
            captacao: null,
            contatos: null,
            conversao: null,
            nps: null,
            receita: null
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check theme preference
            const savedTheme = localStorage.getItem('cockpit_theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const lightIcon = document.getElementById('lightIcon');
                const darkIcon = document.getElementById('darkIcon');
                if (lightIcon) lightIcon.classList.add('hidden');
                if (darkIcon) darkIcon.classList.remove('hidden');
            }
            
            const isLoggedIn = localStorage.getItem('cockpit_logged_in');
            if (isLoggedIn === 'true') {
                showMainApp();
                loadData();
                updateDashboard();
            }
            
            // Set today's date
            const now = new Date();
            const dataContato = document.getElementById('dataContato');
            const horaContato = document.getElementById('horaContato');
            const pipelineDataContato = document.getElementById('pipelineDataContato');
            
            if (dataContato) dataContato.value = now.toISOString().split('T')[0];
            if (horaContato) horaContato.value = now.toTimeString().slice(0, 5);
            if (pipelineDataContato) pipelineDataContato.value = now.toISOString().split('T')[0];
            
            // Setup form submission
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            // Setup drag and drop
            setupDragAndDrop();
            
            // Close dropdowns and modals on outside click
            document.addEventListener('click', function(event) {
                // Close period dropdowns when clicking outside of period selectors or the global dropdown
                if (!event.target.closest('.period-selector') && !event.target.closest('.period-dropdown')) {
                    const globalDropdown = document.getElementById('globalPeriodDropdown');
                    if (globalDropdown && globalDropdown.classList.contains('show')) {
                        globalDropdown.classList.remove('show');
                        globalDropdown.style.display = 'none';
                    }
                }
            });
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });
        
        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            
            const lightIcon = document.getElementById('lightIcon');
            const darkIcon = document.getElementById('darkIcon');
            
            if (lightIcon) lightIcon.classList.toggle('hidden', isDark);
            if (darkIcon) darkIcon.classList.toggle('hidden', !isDark);
            
            localStorage.setItem('cockpit_theme', isDark ? 'dark' : 'light');
            
            // Update chart colors if exists
            if (performanceChart) {
                updateChartColors();
            }
        }
        
        // Tab Navigation
        function switchTab(tab) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.main-content').forEach(c => c.classList.remove('active'));
            if (tab === 'dashboard') {
                document.getElementById('dashboardContent').classList.add('active');
            } else if (tab === 'pipeline') {
                document.getElementById('pipelineContent').classList.add('active');
            }
        }
        
        // Secret Access Function
        function secretAccess() {
            const loginPage = document.getElementById('loginPage');
            const mainApp = document.getElementById('mainApp');
            
            if (loginPage) loginPage.style.display = 'none';
            if (mainApp) mainApp.style.display = 'block';
            
            localStorage.setItem('cockpit_logged_in', 'true');
            localStorage.setItem('cockpit_user', 'secret_user');
            localStorage.setItem('cockpit_user_role', 'Master');
            
            loadData();
            updateDashboard();
        }
        
        // Login Handler
        function handleLogin(event) {
            event.preventDefault();
            showLoading();
            
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            
            if (!emailInput || !passwordInput) {
                hideLoading();
                showToast('Erro no formulário de login', 'error');
                return;
            }
            
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            
            // Simulate async login
            setTimeout(() => {
                const user = settings.users.find(u => u.email === email && atob(u.password) === password);
                
                if (user) {
                    const loginPage = document.getElementById('loginPage');
                    const mainApp = document.getElementById('mainApp');
                    
                    if (loginPage) loginPage.style.display = 'none';
                    if (mainApp) mainApp.style.display = 'block';
                    
                    localStorage.setItem('cockpit_logged_in', 'true');
                    localStorage.setItem('cockpit_user', email);
                    localStorage.setItem('cockpit_user_role', user.role);
                    
                    loadData();
                    updateDashboard();
                    
                    hideLoading();
                    showToast('Login realizado com sucesso!', 'success');
                } else {
                    hideLoading();
                    showToast('Email ou senha incorretos', 'error');
                    if (passwordInput) passwordInput.value = '';
                }
            }, 500);
        }
        
        function showMainApp() {
            const loginPage = document.getElementById('loginPage');
            const mainApp = document.getElementById('mainApp');
            
            if (loginPage) loginPage.style.display = 'none';
            if (mainApp) mainApp.style.display = 'block';
        }
        
        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                showLoading();
                localStorage.removeItem('cockpit_logged_in');
                localStorage.removeItem('cockpit_user');
                localStorage.removeItem('cockpit_user_role');
                
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        }
        
        // Loading Functions
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.add('show');
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.remove('show');
        }
        
        // Toast Notifications
        function showToast(message, type = 'success', title = '') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg class="toast-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' :
                      type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' :
                      '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>'}
                </svg>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        // Data Management
        function loadData() {
            showLoading();
            
            // Load dashboard data
            const savedData = localStorage.getItem('cockpit_data');
            if (savedData) {
                dashboardData = JSON.parse(savedData);
                // Garantir que registros antigos possuam a propriedade 'sucesso'
                dashboardData = dashboardData.map(item => {
                    // For backwards compatibility, coerce numeric IDs to strings so comparisons work reliably
                    if (item.id !== undefined && typeof item.id !== 'string') {
                        item.id = String(item.id);
                    }
                    if (item.sucesso === undefined) {
                        // Se não houver campo de sucesso, assuma que o sucesso equivale ao movimento financeiro
                        return Object.assign({}, item, { sucesso: !!item.gerouVolume });
                    }
                    return item;
                });
            } else {
                // Sample data
                dashboardData = [
                    {
                        id: Date.now(),
                        dataContato: new Date().toISOString().split('T')[0],
                        horaContato: '10:30',
                        idCliente: 'CLI001',
                        tipoAtividade: 'prospeccao',
                        canal: 'ligacao',
                        origem: 'indicacao_ecossistema',
                        gerenteIndicador: 'João Silva',
                        gerouVolume: true,
                        estrategia: 'principalidade',
                        valor: 150000,
                        produto: 'rf_bancarios',
                        comissaoTAF: 0.5,
                        repasseROA: 120,
                        descricao: 'Cliente interessado em diversificação'
                    }
                ];
            }
            
            // Load pipeline data
            const savedPipeline = localStorage.getItem('cockpit_pipeline');
            if (savedPipeline) {
                pipelineData = JSON.parse(savedPipeline);
            }
            
            // Load activities
            const savedActivities = localStorage.getItem('cockpit_activities');
            if (savedActivities) {
                scheduledActivities = JSON.parse(savedActivities);
            }
            
            // Load settings
            const savedSettings = localStorage.getItem('cockpit_settings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
            
            hideLoading();
        }
        
        function saveLocalData() {
            localStorage.setItem('cockpit_data', JSON.stringify(dashboardData));
        }
        
        function savePipelineData() {
            localStorage.setItem('cockpit_pipeline', JSON.stringify(pipelineData));
        }
        
        function saveActivitiesData() {
            localStorage.setItem('cockpit_activities', JSON.stringify(scheduledActivities));
        }
        
        function saveSettings() {
            // Save API settings
            const apiKey = document.getElementById('apiKey');
            const sheetUrl = document.getElementById('sheetUrl');
            const autoSync = document.getElementById('autoSync');
            
            if (apiKey) settings.api.key = apiKey.value;
            if (sheetUrl) settings.api.sheetUrl = sheetUrl.value;
            if (autoSync) settings.api.autoSync = autoSync.checked;
            
            localStorage.setItem('cockpit_settings', JSON.stringify(settings));
            showToast('Configurações salvas com sucesso!', 'success');
            
            // Start auto sync if enabled
            if (settings.api.autoSync && settings.api.key && settings.api.sheetUrl) {
                startAutoSync();
            }
        }
        
        // Dashboard Update
        function updateDashboard() {
            updateAllKPIs();
            updatePipelineTable();
            generateInsights();
        }
        
        // KPI Updates
        function updateAllKPIs() {
            updateCaptacao();
            updateReceita();
            updateContatos();
            updateConversao();
            updateNPS();
            updateAtividades();
        }
        
        function getDataForPeriod(period, cardType) {
            const now = new Date();
            let startDate = new Date();
            let endDate = new Date();
            
            if (period === 'custom' && customPeriods[cardType]) {
                startDate = new Date(customPeriods[cardType].start);
                endDate = new Date(customPeriods[cardType].end);
                endDate.setHours(23, 59, 59, 999);
            } else {
                switch(period) {
                    case 'day':
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'quarter':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        endDate = new Date(now.getFullYear(), quarter * 3 + 3, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'semester':
                        const semester = now.getMonth() < 6 ? 0 : 6;
                        startDate = new Date(now.getFullYear(), semester, 1);
                        endDate = new Date(now.getFullYear(), semester + 6, 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'quarter':
                        // Últimos 3 meses
                        startDate.setMonth(startDate.getMonth() - 3);
                        break;
                }
            }
            
            return dashboardData.filter(item => {
                const itemDate = new Date(item.dataContato);
                return itemDate >= startDate && itemDate <= endDate;
            });
        }
        
        function updateCaptacao() {
            const period = cardPeriods.captacao;
            const data = getDataForPeriod(period, 'captacao');
            
            const total = data
                .filter(item => item.gerouVolume)
                .reduce((sum, item) => sum + (item.valor || 0), 0);
            
            const periodText = getPeriodText(period, 'captacao');
            const meta = getMetaForPeriod(period, settings.metas.captacaoSemestral);
            const progress = Math.min((total / meta) * 100, 100);
            
            updateKPICard('captacao', total, meta, progress, periodText);
        }
        
        function updateReceita() {
            const period = cardPeriods.receita;
            const data = getDataForPeriod(period, 'receita');
            
            const total = data
                .filter(item => item.gerouVolume)
                .reduce((sum, item) => sum + (item.repasseROA || 0), 0);

            // Calcular distribuição por classe de ativo
            const breakdownMap = {};
            data.filter(item => item.gerouVolume).forEach(item => {
                // Classificar o produto ou estratégia em uma classe de ativo, tratando variações de nomes
                let classe = 'Outros';
                // Use both produto e estrategia para determinar a classe
                const prodStr = ((item.produto || '') + ' ' + (item.estrategia || '')).toLowerCase();
                // Normalizar string removendo acentos
                const normalized = prodStr.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                // Renda Fixa: inclui abreviações, palavras-chave e conta corrente
                if (normalized.includes('rf') || normalized.includes('renda fixa') || (normalized.includes('saldo') && normalized.includes('conta')) || normalized.includes('saldo_em_conta') || normalized.includes('bancario') || normalized.includes('bancarios')) {
                    classe = 'Renda Fixa';
                } else if (normalized.includes('credito')) {
                    classe = 'Crédito';
                } else if (normalized.includes('coe')) {
                    classe = 'COE';
                } else if (normalized.includes('fund') || normalized.includes('fundo')) {
                    classe = 'Fundos';
                } else if (normalized.includes('previd')) {
                    classe = 'Previdência';
                } else if (normalized.includes('variavel') || normalized.includes('acao')) {
                    classe = 'Renda Variável';
                } else if (normalized.includes('deb') || normalized.includes('debenture')) {
                    classe = 'Debêntures';
                } else if (normalized.includes('consorcio')) {
                    classe = 'Consórcio';
                }
                if (!breakdownMap[classe]) breakdownMap[classe] = 0;
                breakdownMap[classe] += item.repasseROA || 0;
            });
            // Construir HTML para breakdown
            const breakdownContainer = document.getElementById('receitaBreakdown');
            if (breakdownContainer) {
                const entries = Object.entries(breakdownMap).sort((a,b) => b[1] - a[1]);
                if (entries.length > 0) {
                    breakdownContainer.innerHTML = entries.map(([classe, valor]) => {
                        return `<div class="kpi-meta-item"><span class="kpi-meta-label">${classe}:</span><span class="kpi-meta-value">${formatCurrency(valor)}</span></div>`;
                    }).join('');
                } else {
                    breakdownContainer.innerHTML = '<div class="kpi-meta-item"><span class="kpi-meta-label">Nenhum dado disponível</span></div>';
                }
            }
            
            const periodText = getPeriodText(period, 'receita');
            const meta = getMetaForPeriod(period, settings.metas.receitaSemestral);
            const progress = Math.min((total / meta) * 100, 100);
            
            updateKPICard('receita', total, meta, progress, periodText);
        }
        
        function updateContatos() {
            const period = cardPeriods.contatos;
            const data = getDataForPeriod(period, 'contatos');
            
            const relacionamento = data.filter(item => item.tipoAtividade === 'relacionamento').length;
            const prospeccao = data.filter(item => item.tipoAtividade === 'prospeccao').length;
            const total = data.length;
            
            // Check daily goal for today
            const today = new Date();
            const todayContacts = dashboardData.filter(item => {
                const itemDate = new Date(item.dataContato);
                return itemDate.toDateString() === today.toDateString();
            }).length;
            
            const contatosValue = document.getElementById('contatosValue');
            const contatosRel = document.getElementById('contatosRel');
            const contatosProsp = document.getElementById('contatosProsp');
            const contatosMetaDisplay = document.getElementById('contatosMetaDisplay');
            const contatosCard = document.getElementById('contatosCard');
            const contatosGoalMessage = document.getElementById('contatosGoalMessage');
            
            if (contatosValue) contatosValue.textContent = total;
            if (contatosRel) contatosRel.textContent = relacionamento;
            if (contatosProsp) contatosProsp.textContent = prospeccao;
            if (contatosMetaDisplay) contatosMetaDisplay.textContent = settings.metas.contatosDia;
            
            // Update card status based on daily goal
            if (contatosCard) {
                contatosCard.classList.remove('on-track', 'off-track', 'warning');
                
                if (todayContacts >= settings.metas.contatosDia) {
                    contatosCard.classList.add('on-track');
                    if (contatosGoalMessage) {
                        contatosGoalMessage.textContent = `🎯 Meta diária atingida! Excelente trabalho!`;
                        contatosGoalMessage.className = 'goal-message success';
                        contatosGoalMessage.style.display = 'flex';
                    }
                } else if (todayContacts >= settings.metas.contatosDia * 0.7) {
                    contatosCard.classList.add('warning');
                    const remaining = settings.metas.contatosDia - todayContacts;
                    if (contatosGoalMessage) {
                        contatosGoalMessage.textContent = `📈 Quase lá! Faltam ${remaining} contatos para a meta diária.`;
                        contatosGoalMessage.className = 'goal-message warning';
                        contatosGoalMessage.style.display = 'flex';
                    }
                } else {
                    contatosCard.classList.add('off-track');
                    const remaining = settings.metas.contatosDia - todayContacts;
                    if (contatosGoalMessage) {
                        contatosGoalMessage.textContent = `⚠️ Faltam ${remaining} contatos para atingir a meta diária.`;
                        contatosGoalMessage.className = 'goal-message danger';
                        contatosGoalMessage.style.display = 'flex';
                    }
                }
            }
        }
        
        function updateConversao() {
            const period = cardPeriods.conversao;
            const data = getDataForPeriod(period, 'conversao');
            
            const totalContatos = data.length;
            // Considera atividades bem sucedidas (sucesso) como conversões
            const negocios = data.filter(item => item.sucesso).length;
            const taxa = totalContatos > 0 ? (negocios / totalContatos * 100) : 0;
            
            const conversaoValue = document.getElementById('conversaoValue');
            const totalNegocios = document.getElementById('totalNegocios');
            const conversaoMetaDisplay = document.getElementById('conversaoMetaDisplay');
            const conversaoCard = document.getElementById('conversaoCard');
            const conversaoProgressBar = document.getElementById('conversaoProgressBar');
            
            if (conversaoValue) conversaoValue.textContent = taxa.toFixed(1) + '%';
            if (totalNegocios) totalNegocios.textContent = negocios;
            if (conversaoMetaDisplay) conversaoMetaDisplay.textContent = settings.metas.conversaoMensal + '%';
            
            // Update card status
            if (conversaoCard) {
                conversaoCard.classList.remove('on-track', 'off-track', 'warning');
                
                if (taxa >= settings.metas.conversaoMensal) {
                    conversaoCard.classList.add('on-track');
                } else if (taxa >= settings.metas.conversaoMensal * 0.7) {
                    conversaoCard.classList.add('warning');
                } else {
                    conversaoCard.classList.add('off-track');
                }
            }
            
            // Update progress bar
            if (conversaoProgressBar) {
                const progress = Math.min((taxa / settings.metas.conversaoMensal) * 100, 100);
                conversaoProgressBar.style.width = progress + '%';
                
                conversaoProgressBar.classList.remove('success', 'warning', 'danger');
                if (taxa >= settings.metas.conversaoMensal) {
                    conversaoProgressBar.classList.add('success');
                } else if (taxa >= settings.metas.conversaoMensal * 0.7) {
                    conversaoProgressBar.classList.add('warning');
                } else {
                    conversaoProgressBar.classList.add('danger');
                }
            }
        }

        /**
         * Exibe ou oculta a distribuição de receita por classe de ativo no card de receita
         */
        function toggleReceitaBreakdown(event) {
            // Impede que o click abra o modal de detalhes
            event.stopPropagation();
            const container = document.getElementById('receitaBreakdown');
            if (!container) return;
            // Toggle visibility: use style and class for compatibility
            const isHidden = container.classList.contains('hidden') || container.style.display === 'none';
            if (isHidden) {
                container.classList.remove('hidden');
                container.style.display = '';
            } else {
                container.classList.add('hidden');
                container.style.display = 'none';
            }
        }
        
        function updateNPS() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            // Get unique clients with their last contact date
            const clientsMap = new Map();
            dashboardData.forEach(item => {
                const clientId = item.idCliente;
                const contactDate = new Date(item.dataContato);
                
                if (!clientsMap.has(clientId) || contactDate > new Date(clientsMap.get(clientId).dataContato)) {
                    clientsMap.set(clientId, item);
                }
            });
            
            // Filter clients whose last contact was more than 30 days ago
            const eligibleClients = Array.from(clientsMap.values()).filter(item => 
                new Date(item.dataContato) <= thirtyDaysAgo
            );
            
            const npsScore = eligibleClients.length > 0 ? 72 : 0; // Simulated NPS
            
            const npsValue = document.getElementById('npsValue');
            const clientesAptos = document.getElementById('clientesAptos');
            const npsMetaDisplay = document.getElementById('npsMetaDisplay');
            const npsCard = document.getElementById('npsCard');
            const npsProgressBar = document.getElementById('npsProgressBar');
            
            if (npsValue) npsValue.textContent = npsScore;
            if (clientesAptos) clientesAptos.textContent = eligibleClients.length;
            if (npsMetaDisplay) npsMetaDisplay.textContent = settings.metas.nps;
            
            // Update card status
            if (npsCard) {
                npsCard.classList.remove('on-track', 'off-track', 'warning');
                
                if (npsScore >= settings.metas.nps) {
                    npsCard.classList.add('on-track');
                } else if (npsScore >= settings.metas.nps * 0.8) {
                    npsCard.classList.add('warning');
                } else {
                    npsCard.classList.add('off-track');
                }
            }
            
            // Update progress bar
            if (npsProgressBar) {
                const progress = Math.min((npsScore / settings.metas.nps) * 100, 100);
                npsProgressBar.style.width = progress + '%';
                
                npsProgressBar.classList.remove('success', 'warning', 'danger');
                if (npsScore >= settings.metas.nps) {
                    npsProgressBar.classList.add('success');
                } else if (npsScore >= settings.metas.nps * 0.8) {
                    npsProgressBar.classList.add('warning');
                } else {
                    npsProgressBar.classList.add('danger');
                }
            }
        }
        
        function updateAtividades() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const thisWeekEnd = new Date(today);
            thisWeekEnd.setDate(today.getDate() + (7 - today.getDay()));
            
            const todayActivities = scheduledActivities.filter(item => {
                const activityDate = new Date(item.data);
                return activityDate.toDateString() === today.toDateString();
            }).length;
            
            const weekActivities = scheduledActivities.filter(item => {
                const activityDate = new Date(item.data);
                return activityDate >= today && activityDate <= thisWeekEnd;
            }).length;
            
            const overdueActivities = scheduledActivities.filter(item => {
                const activityDateTime = new Date(item.data + ' ' + item.hora);
                return activityDateTime < new Date();
            }).length;
            
            const atividadesValue = document.getElementById('atividadesValue');
            const atividadesHoje = document.getElementById('atividadesHoje');
            const atividadesSemana = document.getElementById('atividadesSemana');
            const atividadesAtrasadas = document.getElementById('atividadesAtrasadas');
            const atividadesCard = document.getElementById('atividadesCard');
            
            if (atividadesValue) atividadesValue.textContent = scheduledActivities.length;
            if (atividadesHoje) atividadesHoje.textContent = todayActivities;
            if (atividadesSemana) atividadesSemana.textContent = weekActivities;
            if (atividadesAtrasadas) atividadesAtrasadas.textContent = overdueActivities;
            
            // Update card status
            if (atividadesCard) {
                atividadesCard.classList.remove('on-track', 'off-track');
                if (overdueActivities > 0) {
                    atividadesCard.classList.add('off-track');
                } else {
                    atividadesCard.classList.add('on-track');
                }
            }
        }
        
        function updateKPICard(type, value, meta, progress, periodText) {
            const valueElement = document.getElementById(`${type}Value`);
            const metaElement = document.getElementById(`${type}MetaDisplay`);
            const periodElement = document.getElementById(`${type}Period`);
            const progressBar = document.getElementById(`${type}ProgressBar`);
            const card = document.getElementById(`${type}Card`);
            const goalMessage = document.getElementById(`${type}GoalMessage`);
            
            if (valueElement) valueElement.textContent = formatCurrency(value);
            if (metaElement) metaElement.textContent = formatCurrency(meta);
            if (periodElement) periodElement.textContent = periodText;
            
            if (progressBar) {
                progressBar.style.width = progress + '%';
                progressBar.classList.remove('success', 'warning', 'danger');
                
                if (progress >= 100) {
                    progressBar.classList.add('success');
                } else if (progress >= 70) {
                    progressBar.classList.add('warning');
                } else {
                    progressBar.classList.add('danger');
                }
            }
            
            // Update card status
            if (card) {
                card.classList.remove('on-track', 'off-track', 'warning');
                
                if (progress >= 100) {
                    card.classList.add('on-track');
                    if (goalMessage) {
                        goalMessage.textContent = `🎯 Meta ${periodText.toLowerCase()} atingida! Parabéns!`;
                        goalMessage.className = 'goal-message success';
                        goalMessage.style.display = 'flex';
                    }
                } else if (progress >= 70) {
                    card.classList.add('warning');
                    const remaining = meta - value;
                    if (goalMessage) {
                        goalMessage.textContent = `📈 Ótimo progresso! Faltam ${formatCurrency(remaining)} para a meta.`;
                        goalMessage.className = 'goal-message warning';
                        goalMessage.style.display = 'flex';
                    }
                } else {
                    card.classList.add('off-track');
                    const remaining = meta - value;
                    if (goalMessage) {
                        goalMessage.textContent = `⚠️ Atenção! Faltam ${formatCurrency(remaining)} para a meta.`;
                        goalMessage.className = 'goal-message danger';
                        goalMessage.style.display = 'flex';
                    }
                }
            }
        }
        
        function getPeriodText(period, cardType) {
            if (period === 'custom' && customPeriods[cardType]) {
                return `${formatDate(customPeriods[cardType].start)} - ${formatDate(customPeriods[cardType].end)}`;
            }
            
            const texts = {
                'day': 'Hoje',
                'week': 'Semanal',
                'month': 'Mensal',
                'quarter': 'Trimestral',
                'semester': 'Semestral'
            };
            
            return texts[period] || period;
        }
        
        function getMetaForPeriod(period, semesterMeta) {
            const metas = {
                'day': semesterMeta / 180,
                'week': semesterMeta / 26,
                'month': semesterMeta / 6,
                'quarter': semesterMeta / 2,
                'semester': semesterMeta
            };
            
            return metas[period] || semesterMeta;
        }
        
    // Toggle the global period dropdown for a specific card
    function togglePeriodDropdown(event, cardType) {
        event.stopPropagation();
        const globalDropdown = document.getElementById('globalPeriodDropdown');
        if (!globalDropdown) return;
        // If clicking the same card while dropdown is open, close it
        if (globalDropdown.classList.contains('show') && globalDropdown.dataset.cardType === cardType) {
            globalDropdown.classList.remove('show');
            globalDropdown.style.display = 'none';
            return;
        }
        // Populate dropdown with options
        globalDropdown.innerHTML = '';
        globalDropdown.dataset.cardType = cardType;
        // Define options and labels
        const options = [
            { value: 'day', label: 'Dia' },
            { value: 'week', label: 'Semana' },
            { value: 'month', label: 'Mês' },
            { value: 'quarter', label: 'Trimestre' },
            { value: 'semester', label: 'Semestre' }
        ];
        const currentPeriod = cardPeriods[cardType] || 'month';
        // Create option elements
        options.forEach(opt => {
            const div = document.createElement('div');
            div.className = 'period-option';
            if (opt.value === currentPeriod) {
                div.classList.add('active');
            }
            div.textContent = opt.label;
            div.addEventListener('click', function(ev) {
                ev.stopPropagation();
                // Update period and hide dropdown
                cardPeriods[cardType] = opt.value;
                customPeriods[cardType] = null;
                globalDropdown.classList.remove('show');
                globalDropdown.style.display = 'none';
                updateAllKPIs();
            });
            globalDropdown.appendChild(div);
        });
        // Divider for custom period
        const divider = document.createElement('div');
        divider.className = 'period-divider';
        globalDropdown.appendChild(divider);
        // Custom period option
        const customDiv = document.createElement('div');
        customDiv.className = 'period-option';
        customDiv.textContent = 'Período Personalizado';
        customDiv.addEventListener('click', function(ev) {
            ev.stopPropagation();
            // Toggle custom panel visibility
            const panel = document.getElementById('globalPeriodCustom');
            if (panel) {
                panel.classList.toggle('hidden');
            }
        });
        globalDropdown.appendChild(customDiv);
        // Create or retrieve custom period panel
        let customPanel = document.getElementById('globalPeriodCustom');
        if (!customPanel) {
            customPanel = document.createElement('div');
            customPanel.id = 'globalPeriodCustom';
            customPanel.className = 'period-custom hidden';
            // Date range container
            const rangeContainer = document.createElement('div');
            rangeContainer.className = 'date-range-container';
            const startInput = document.createElement('input');
            startInput.type = 'date';
            startInput.id = 'global-custom-start';
            startInput.className = 'date-input';
            const endInput = document.createElement('input');
            endInput.type = 'date';
            endInput.id = 'global-custom-end';
            endInput.className = 'date-input';
            const span = document.createElement('span');
            span.style.margin = '0 0.5rem';
            span.textContent = 'até';
            rangeContainer.appendChild(startInput);
            rangeContainer.appendChild(span);
            rangeContainer.appendChild(endInput);
            customPanel.appendChild(rangeContainer);
            // Apply button
            const applyBtn = document.createElement('button');
            applyBtn.className = 'btn btn-secondary';
            applyBtn.style.marginTop = '0.5rem';
            applyBtn.style.width = '100%';
            applyBtn.textContent = 'Aplicar';
            applyBtn.addEventListener('click', function(ev) {
                ev.stopPropagation();
                // Validate inputs
                const startDate = startInput.value;
                const endDate = endInput.value;
                if (!startDate || !endDate) {
                    showToast('Por favor, selecione as datas de início e fim.', 'warning');
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    showToast('A data de início deve ser anterior à data de fim.', 'error');
                    return;
                }
                const diffMs = new Date(endDate) - new Date(startDate);
                const diffDays = diffMs / (1000 * 60 * 60 * 24);
                if (diffDays > 365) {
                    showToast('O período personalizado não pode exceder 1 ano.', 'warning');
                    return;
                }
                customPeriods[cardType] = { start: startDate, end: endDate };
                cardPeriods[cardType] = 'custom';
                // Hide dropdown and panel
                globalDropdown.classList.remove('show');
                globalDropdown.style.display = 'none';
                customPanel.classList.add('hidden');
                // Update KPIs
                updateAllKPIs();
            });
            customPanel.appendChild(applyBtn);
            // Append panel to dropdown
            globalDropdown.appendChild(customPanel);
        } else {
            // Reset hidden state when opening new dropdown
            customPanel.classList.add('hidden');
            // Move panel into dropdown if not already there
            if (customPanel.parentElement !== globalDropdown) {
                globalDropdown.appendChild(customPanel);
            }
        }
        // Position dropdown relative to button
        const button = event.currentTarget;
        const rect = button.getBoundingClientRect();
        // Determine width (min 200px)
        const dropdownWidth = 200;
        let left = rect.left;
        if (left + dropdownWidth > window.innerWidth - 8) {
            left = window.innerWidth - dropdownWidth - 8;
        }
        globalDropdown.style.left = `${left}px`;
        globalDropdown.style.top = `${rect.bottom + 4}px`;
        globalDropdown.style.display = 'block';
        globalDropdown.classList.add('show');
    }

    /**
     * Seleciona um período predefinido (dia, semana, mês, trimestre, semestre) para o card especificado.
     * Atualiza o estado global, alterna a classe `active` nos itens do menu e oculta seções personalizadas.
     * @param {string} cardType Identificador do card (captacao, receita, etc.)
     * @param {string} period Período a ser selecionado (day, week, month, quarter, semester)
     */
    function selectPeriod(cardType, period) {
        event.stopPropagation();
        cardPeriods[cardType] = period;
        customPeriods[cardType] = null;
        // Atualiza a aparência das opções no dropdown
        const dropdown = document.getElementById(`${cardType}-period-dropdown`);
        if (dropdown) {
            dropdown.querySelectorAll('.period-option').forEach(option => {
                option.classList.remove('active');
            });
            // Adiciona a classe active ao item clicado, se existir
            if (event.target && event.target.classList.contains('period-option')) {
                event.target.classList.add('active');
            }
            // Oculta seletor personalizado se estiver visível
            const customDiv = document.getElementById(`${cardType}-custom`);
            if (customDiv) customDiv.classList.add('hidden');
            // Fecha e oculta o dropdown
            dropdown.classList.remove('show');
            dropdown.style.display = 'none';
        }
        // Atualiza todos os KPIs para refletir o novo período selecionado
        updateAllKPIs();
    }

    /**
     * Alterna a exibição dos campos de período personalizado para o card especificado. Caso já estejam
     * visíveis, esconde; caso contrário, mostra.
     * @param {string} cardType Identificador do card
     */
    function selectCustomPeriod(cardType) {
        event.stopPropagation();
        const customDiv = document.getElementById(`${cardType}-custom`);
        if (customDiv) {
            customDiv.classList.toggle('hidden');
        }
    }

    /**
     * Aplica o período personalizado definido nos campos de data inicial e final. Valida as datas
     * selecionadas (ordem correta e intervalo máximo de 1 ano) antes de atualizar os KPIs.
     * @param {string} cardType Identificador do card
     */
    function applyCustomPeriod(cardType) {
        event.stopPropagation();
        const startInput = document.getElementById(`${cardType}-start`);
        const endInput = document.getElementById(`${cardType}-end`);
        if (!startInput || !endInput) return;
        const startDate = startInput.value;
        const endDate = endInput.value;
        if (!startDate || !endDate) {
            showToast('Por favor, selecione as datas de início e fim.', 'warning');
            return;
        }
        if (new Date(startDate) > new Date(endDate)) {
            showToast('A data de início deve ser anterior à data de fim.', 'error');
            return;
        }
        // Garantir que o intervalo não exceda 1 ano (365 dias)
        const diffMs = new Date(endDate) - new Date(startDate);
        const diffDays = diffMs / (1000 * 60 * 60 * 24);
        if (diffDays > 365) {
            showToast('O período personalizado não pode exceder 1 ano.', 'warning');
            return;
        }
        customPeriods[cardType] = { start: startDate, end: endDate };
        cardPeriods[cardType] = 'custom';
        // Fecha o dropdown
        const dropdown = document.getElementById(`${cardType}-period-dropdown`);
        if (dropdown) {
            dropdown.classList.remove('show');
            dropdown.style.display = 'none';
        }
        // Atualiza KPIs
        updateAllKPIs();
    }

    // Close dropdowns when clicking outside
    window.addEventListener('click', function() {
        document.querySelectorAll('.period-dropdown.show').forEach(dd => {
            dd.classList.remove('show');
            // Hide dropdown by resetting inline display property
            dd.style.display = 'none';
        });
        // Hide select menu when clicking outside
        const menu = document.getElementById('selectMenu');
        if (menu) menu.classList.add('hidden');
        // Hide filter menu when clicking outside
        if (typeof currentFilterMenu !== 'undefined' && currentFilterMenu) {
            currentFilterMenu.remove();
            currentFilterMenu = null;
        }
    });

    // Toggle visibility of the selection menu
    function toggleSelectMenu(event) {
        event.stopPropagation();
        const menu = document.getElementById('selectMenu');
        if (menu) menu.classList.toggle('hidden');
    }
    // Select rows: if all is true, check all; otherwise just enable selection mode
    function selectRows(all) {
        const menu = document.getElementById('selectMenu');
        if (menu) menu.classList.add('hidden');
        selectionMode = true;
        const checkboxes = document.querySelectorAll('.row-select');
        checkboxes.forEach(cb => {
            cb.classList.remove('hidden-select');
            cb.checked = all ? true : false;
        });
        // Show action buttons
        const deleteBtn = document.getElementById('deleteSelectedBtn');
        const dupBtn = document.getElementById('duplicateSelectedBtn');
        if (deleteBtn) deleteBtn.classList.remove('hidden');
        if (dupBtn) dupBtn.classList.remove('hidden');
    }

    /* === Period Modal Functions === */
    let periodModalCardType = null;
    function openPeriodModal(event, cardType) {
        event.stopPropagation();
        periodModalCardType = cardType;
        const modal = document.getElementById('periodModal');
        if (modal) {
            modal.classList.add('show');
        }
    }
    function closePeriodModal() {
        const modal = document.getElementById('periodModal');
        if (modal) {
            modal.classList.remove('show');
        }
    }
    function selectPeriodFromModal(period) {
        if (!periodModalCardType) return;
        selectPeriod(periodModalCardType, period);
        closePeriodModal();
    }
        
        // Modal Functions
        function showActivityChoice() {
            const modal = document.getElementById('activityChoiceModal');
            if (modal) modal.classList.add('show');
        }
        
        function showActivityForm() {
            closeModal('activityChoiceModal');
            const modal = document.getElementById('activityModal');
            if (modal) modal.classList.add('show');
        }
        
        function showPipelineForm() {
            closeModal('activityChoiceModal');
            const modal = document.getElementById('pipelineModal');
            if (modal) modal.classList.add('show');
        }
        
        function showChartModal() {
            const modal = document.getElementById('chartModal');
            if (modal) {
                modal.classList.add('show');
                if (!performanceChart) {
                    initChart();
                }
                updateChart();
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('show');
        }
        
        // Form Functions
        function checkOrigemFields() {
            const origem = document.getElementById('origem');
            if (!origem) return;
            
            const value = origem.value;
            const gerenteField = document.querySelector('.gerente-field');
            const clienteField = document.querySelector('.cliente-field');
            
            if (gerenteField) gerenteField.classList.add('hidden');
            if (clienteField) clienteField.classList.add('hidden');
            
            if (value === 'indicacao_ecossistema' && gerenteField) {
                gerenteField.classList.remove('hidden');
            } else if (value === 'indicacao_base' && clienteField) {
                clienteField.classList.remove('hidden');
            }
        }
        
        function toggleVolumeFields() {
            const gerouVolume = document.getElementById('gerouVolume');
            if (!gerouVolume) return;
            
            const fields = document.querySelectorAll('.volume-fields');
            
            fields.forEach(field => {
                if (gerouVolume.checked) {
                    field.classList.remove('hidden');
                } else {
                    field.classList.add('hidden');
                }
            });
        }
        
        function calculateCommission() {
            const produto = document.getElementById('produto');
            if (!produto) return;
            
            const commissions = {
                'rf_bancarios': 0.5,
                'rf_bancarios_toro': 0.5,
                'credito_privado': 1.2,
                'credito_privado_toro': 1.2,
                'fundos': 0.8,
                'coe': 2.0,
                'previdencia': 3.0,
                'renda_variavel': 0.3
            };
            
            const comissaoTAF = document.getElementById('comissaoTAF');
            if (comissaoTAF) {
                comissaoTAF.value = (commissions[produto.value] || 0).toString().replace('.', ',');
                calculateROA();
            }
        }
        
        function calculateROA() {
            const produto = document.getElementById('produto');
            const valor = document.getElementById('valor');
            const comissaoTAF = document.getElementById('comissaoTAF');
            const repasseROA = document.getElementById('repasseROA');
            
            if (!produto || !valor || !comissaoTAF || !repasseROA) return;
            
            const valorNum = parseCurrency(valor.value) || 0;
            const comissaoNum = parseFloat(comissaoTAF.value.replace(',', '.')) || 0;
            
            let roa = 0;
            
            switch(produto.value) {
                case 'rf_bancarios':
                case 'rf_bancarios_toro':
                    roa = (valorNum / 100000) * 80;
                    break;
                case 'coe':
                    roa = (valorNum * comissaoNum / 100) * 0.15;
                    break;
                case 'credito_privado':
                case 'credito_privado_toro':
                    roa = (valorNum * comissaoNum / 100) * 0.30;
                    break;
                case 'previdencia':
                    roa = (valorNum * comissaoNum / 100) * 2.5 * 0.40;
                    break;
                case 'fundos':
                    roa = (valorNum * comissaoNum / 100) * 0.15;
                    break;
                default:
                    roa = valorNum * comissaoNum / 100;
            }
            
            repasseROA.value = formatCurrency(roa).replace('R$ ', '');
        }
        
        function saveData() {
            showLoading();
            
            // Capture dados do formulário
            const captured = {
                // Use a string id when creating new records to avoid precision issues
                id: editingId ? editingId : (Date.now().toString() + '-' + Math.random().toString(36).substring(2)),
                dataContato: document.getElementById('dataContato')?.value || '',
                horaContato: document.getElementById('horaContato')?.value || '',
                idCliente: document.getElementById('idCliente')?.value || '',
                tipoAtividade: document.getElementById('tipoAtividade')?.value || '',
                canal: document.getElementById('canal')?.value || '',
                origem: document.getElementById('origem')?.value || '',
                gerenteIndicador: document.getElementById('gerenteIndicador')?.value || '',
                clienteIndicador: document.getElementById('clienteIndicador')?.value || '',
                gerouVolume: document.getElementById('gerouVolume')?.checked || false,
                estrategia: document.getElementById('estrategia')?.value || '',
                valor: parseCurrency(document.getElementById('valor')?.value || '0') || 0,
                produto: document.getElementById('produto')?.value || '',
                comissaoTAF: parseFloat(document.getElementById('comissaoTAF')?.value.replace(',', '.') || '0') || 0,
                repasseROA: parseCurrency(document.getElementById('repasseROA')?.value || '0') || 0,
                descricao: document.getElementById('descricao')?.value || '',
                sucesso: document.getElementById('atividadeSucesso')?.checked || false
            };

            // Se estiver editando um registro existente, atualiza o registro
            if (editingId) {
                const idx = dashboardData.findIndex(item => item.id === editingId);
                if (idx >= 0) {
                    dashboardData[idx] = Object.assign({}, dashboardData[idx], captured);
                } else {
                    dashboardData.push(captured);
                }
            } else {
                dashboardData.push(captured);
            }
            // Persistir dados
            saveLocalData();
            
            // Se a atividade gerou volume ou foi bem sucedida, agende pesquisa NPS automaticamente
            if (captured.sucesso || captured.gerouVolume) {
                scheduleNPSActivity(captured);
            }
            // Limpar estado de edição
            editingId = null;
            
            // Reset form
            const form = document.getElementById('activityForm');
            if (form) form.reset();
            
            const now = new Date();
            const dataContato = document.getElementById('dataContato');
            const horaContato = document.getElementById('horaContato');
            
            if (dataContato) dataContato.value = now.toISOString().split('T')[0];
            if (horaContato) horaContato.value = now.toTimeString().slice(0, 5);
            
            toggleVolumeFields();
            checkOrigemFields();
            
            updateDashboard();
            closeModal('activityModal');
            
            hideLoading();
            showToast('Atividade registrada com sucesso!', 'success');
        }

        /**
         * Agenda uma pesquisa de NPS automaticamente 30 dias após a data do contato
         * e adiciona uma subtarefa de follow-up uma semana antes do vencimento.
         * @param {Object} activity Registro da atividade recém-salvo
         */
        function scheduleNPSActivity(activity) {
            try {
                // Data do NPS: 30 dias após o contato
                const contactDate = new Date(activity.dataContato);
                if (isNaN(contactDate)) return;
                const npsDate = new Date(contactDate);
                npsDate.setDate(contactDate.getDate() + 30);
                // Subtarefa: 23 dias após contato (7 dias antes do NPS)
                const followDate = new Date(contactDate);
                followDate.setDate(contactDate.getDate() + 23);
                const scheduled = {
                    id: Date.now() + Math.random(),
                    data: npsDate.toISOString().split('T')[0],
                    hora: '09:00',
                    idCliente: activity.idCliente,
                    tipo: 'NPS',
                    subtask: {
                        data: followDate.toISOString().split('T')[0],
                        descricao: 'Follow-up antes da pesquisa NPS'
                    },
                    // permit manual customization; defaults
                    descricao: 'Pesquisa de satisfação (NPS) automática'
                };
                scheduledActivities.push(scheduled);
                // Persistir atividades programadas
                localStorage.setItem('cockpit_activities', JSON.stringify(scheduledActivities));
                // Atualizar contadores de atividades
                updateDashboard();
            } catch (error) {
                console.error('Erro ao agendar NPS:', error);
            }
        }
        
        // Pipeline Functions
        function checkPipelineOrigemFields() {
            const origem = document.getElementById('pipelineOrigem');
            if (!origem) return;
            
            const value = origem.value;
            const gerenteField = document.querySelector('.pipeline-origem-fields.gerente-field');
            const clienteField = document.querySelector('.pipeline-origem-fields.cliente-field');
            
            if (gerenteField) gerenteField.classList.add('hidden');
            if (clienteField) clienteField.classList.add('hidden');
            
            if (value === 'indicacao_ecossistema' && gerenteField) {
                gerenteField.classList.remove('hidden');
            } else if (value === 'indicacao_base' && clienteField) {
                clienteField.classList.remove('hidden');
            }
        }
        
        function savePipeline() {
            showLoading();
            
            const newPipeline = {
                id: Date.now(),
                dataContato: document.getElementById('pipelineDataContato')?.value || '',
                idCliente: document.getElementById('pipelineIdCliente')?.value || '',
                origem: document.getElementById('pipelineOrigem')?.value || '',
                gerenteIndicador: document.getElementById('pipelineGerenteIndicador')?.value || '',
                clienteIndicador: document.getElementById('pipelineClienteIndicador')?.value || '',
                estrategia: document.getElementById('pipelineEstrategia')?.value || '',
                valorPotencial: parseCurrency(document.getElementById('pipelineValor')?.value || '0') || 0,
                observacoes: document.getElementById('pipelineObservacoes')?.value || '',
                ultimoContato: document.getElementById('pipelineDataContato')?.value || ''
            };
            
            pipelineData.push(newPipeline);
            savePipelineData();
            
            // Reset form
            const form = document.getElementById('pipelineForm');
            if (form) form.reset();
            
            const now = new Date();
            const pipelineDataContato = document.getElementById('pipelineDataContato');
            if (pipelineDataContato) pipelineDataContato.value = now.toISOString().split('T')[0];
            
            checkPipelineOrigemFields();
            
            updatePipelineTable();
            closeModal('pipelineModal');
            
            hideLoading();
            showToast('Oportunidade registrada com sucesso!', 'success');
        }
        
        function updatePipelineTable() {
            const tbody = document.getElementById('pipelineTableBody');
            if (!tbody) return;
            
            const searchInput = document.getElementById('pipelineSearch');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            const filteredData = pipelineData.filter(item => {
                return item.idCliente.toLowerCase().includes(searchTerm) ||
                       item.estrategia.toLowerCase().includes(searchTerm) ||
                       (item.gerenteIndicador && item.gerenteIndicador.toLowerCase().includes(searchTerm));
            });
            
            tbody.innerHTML = filteredData.map(item => {
                const lastContact = getLastContactForClient(item.idCliente);
                const daysSinceContact = calculateBusinessDays(lastContact);
                
                let statusIcon = '';
                if (daysSinceContact > 15) {
                    statusIcon = '<svg class="status-icon danger" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
                } else if (daysSinceContact > 10) {
                    statusIcon = '<svg class="status-icon warning" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                }
                
                let indicacaoTag = '';
                if (item.origem === 'indicacao_ecossistema' && item.gerenteIndicador) {
                    indicacaoTag = `<span class="tag">Gerente: ${item.gerenteIndicador}</span>`;
                } else if (item.origem === 'indicacao_base' && item.clienteIndicador) {
                    indicacaoTag = `<span class="tag">Cliente: ${item.clienteIndicador}</span>`;
                }
                
                return `
                    <tr>
                        <td>${formatDate(item.dataContato)}</td>
                        <td>${item.idCliente}</td>
                        <td>${getOriginName(item.origem)}</td>
                        <td>${getStrategyName(item.estrategia)}</td>
                        <td>${formatCurrency(item.valorPotencial)}</td>
                        <td>${indicacaoTag}</td>
                        <td>
                            ${statusIcon}
                            ${daysSinceContact} dias
                        </td>
                        <td class="actions">
                            <button class="action-button" onclick="editPipeline(${item.id})">Editar</button>
                            <button class="action-button secondary" onclick="scheduleActivity(${item.id})">Agendar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterPipeline() {
            updatePipelineTable();
        }
        
        function editPipeline(id) {
            showToast('Funcionalidade de edição será implementada em breve!', 'warning');
        }
        
        function scheduleActivity(pipelineId) {
            showToast('Funcionalidade de agendamento será implementada em breve!', 'warning');
        }
        
        function getLastContactForClient(clientId) {
            const contacts = dashboardData.filter(item => item.idCliente === clientId);
            if (contacts.length === 0) return null;
            
            return contacts.reduce((latest, current) => {
                return new Date(current.dataContato) > new Date(latest.dataContato) ? current : latest;
            }).dataContato;
        }
        
        function calculateBusinessDays(lastContactDate) {
            if (!lastContactDate) return 999;
            
            const last = new Date(lastContactDate);
            const today = new Date();
            let days = 0;
            
            while (last < today) {
                last.setDate(last.getDate() + 1);
                if (last.getDay() !== 0 && last.getDay() !== 6) {
                    days++;
                }
            }
            
            return days;
        }
        
        // Details Modal
        function showDetails(type) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('detailModalTitle');
            const filters = document.getElementById('detailFilters');
            const actionsContainer = document.getElementById('detailActions');
            const tableHead = document.getElementById('detailTableHead');
            const tableBody = document.getElementById('detailTableBody');
            if (!modal || !title || !filters || !tableHead || !tableBody) return;
            // Guardar tipo atual para atualizar após edições
            currentDetailType = type;
            // Limpar filtros, cabeçalhos e linhas
            filters.innerHTML = '';
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            // Reiniciar filtros e seleção
            detailFilters = {};
            selectionMode = false;
            // Clear filter container
            filters.innerHTML = '';
            // Insert actions into the dedicated actions container in the modal header
            if (actionsContainer) {
                actionsContainer.innerHTML = `
                    <div style="position: relative;">
                        <button class="icon-button" onclick="toggleSelectMenu(event)" title="Selecionar registros">
                            <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6v10H9z" />
                            </svg>
                        </button>
                        <div class="select-menu hidden" id="selectMenu">
                            <div class="select-option" onclick="selectRows(false)">Selecionar um</div>
                            <div class="select-option" onclick="selectRows(true)">Selecionar todos</div>
                        </div>
                    </div>
                    <button class="icon-button hidden" id="deleteSelectedBtn" onclick="deleteSelectedRecords()" title="Excluir selecionados">
                        <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    <button class="icon-button hidden" id="duplicateSelectedBtn" onclick="duplicateSelectedRecords()" title="Duplicar selecionados">
                        <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v9a2 2 0 002 2z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v9a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2" />
                        </svg>
                    </button>
                `;
            }
            let headers = [];
            let data = [];
            // Definir cabeçalhos e dados baseados no tipo
            switch(type) {
                case 'captacao':
                    title.textContent = 'Detalhes de Captação';
                    headers = ['Data','ID Cliente','Volume','Origem','Estratégia'];
                    data = dashboardData.filter(item => item.gerouVolume);
                    break;
                case 'contatos':
                    title.textContent = 'Detalhes de Contatos';
                    headers = ['Data','Hora','ID Cliente','Atividade','Canal','Mov. Financeira','Sucesso?'];
                    data = dashboardData;
                    break;
                case 'conversao':
                    title.textContent = 'Negócios não Concretizados';
                    headers = ['Data','ID Cliente','Atividade','Origem','Canal','Observação'];
                    data = dashboardData.filter(item => !item.sucesso);
                    break;
                case 'receita':
                    title.textContent = 'Detalhes de Receita';
                    headers = ['Data','ID Cliente','Produto','Valor','Comissão TAF','ROA'];
                    data = dashboardData.filter(item => item.gerouVolume && item.repasseROA > 0);
                    break;
                case 'atividades':
                    title.textContent = 'Atividades Programadas';
                    headers = ['Data','Hora','ID Cliente','Tipo','Status'];
                    data = scheduledActivities;
                    break;
                case 'nps':
                    title.textContent = 'Clientes Aptos para NPS';
                    headers = ['ID Cliente','Último Contato','Tipo de Atividade','Status'];
                    // Calcular clientes com último contato há mais de 30 dias
                    const thirtyAgo = new Date();
                    thirtyAgo.setDate(thirtyAgo.getDate() - 30);
                    const clientsMap = new Map();
                    dashboardData.forEach(item => {
                        const cid = item.idCliente;
                        const cdate = new Date(item.dataContato);
                        if (!clientsMap.has(cid) || cdate > new Date(clientsMap.get(cid).dataContato)) {
                            clientsMap.set(cid, item);
                        }
                    });
                    data = Array.from(clientsMap.values()).filter(item => new Date(item.dataContato) <= thirtyAgo);
                    break;
            }
            // Store the current headers globally for filtering/sorting
            currentHeaders = headers.slice();
            // Construir cabeçalhos com ícone de filtro
            const theadCells = headers.map((h,i) => {
                return `<th>${h}<button class="filter-icon" onclick="showFilterMenu(event, ${i})" title="Filtrar"><svg width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707L15 12.414V19a1 1 0 01-.553.894l-4 2A1 1 0 019 21v-8.586L3.293 7.293A1 1 0 013 6.586V4z" /></svg></button></th>`;
            }).join('');
            // Adiciona coluna de ações, exceto para NPS (não editável)
            const actionsHeader = type !== 'nps' ? '<th>Ações</th>' : '';
            tableHead.innerHTML = `<tr>${theadCells}${actionsHeader}</tr>`;
            // Construir linhas
            let rowsHTML = '';
            data.forEach(item => {
                let row = '<tr>';
                if (type === 'captacao') {
                    row += `<td><input type="checkbox" class="row-select hidden-select" data-id="${item.id}"> ${formatDate(item.dataContato)}</td>`;
                    row += `<td>${item.idCliente}</td>`;
                    row += `<td>${formatCurrency(item.valor)}</td>`;
                    row += `<td>${getOriginName(item.origem)}</td>`;
                    row += `<td>${getStrategyName(item.estrategia)}</td>`;
                } else if (type === 'contatos') {
                    row += `<td><input type="checkbox" class="row-select hidden-select" data-id="${item.id}"> ${formatDate(item.dataContato)}</td>`;
                    row += `<td>${item.horaContato}</td>`;
                    row += `<td>${item.idCliente}</td>`;
                    row += `<td>${item.tipoAtividade}</td>`;
                    row += `<td>${item.canal}</td>`;
                    row += `<td>${item.gerouVolume ? 'Sim' : 'Não'}</td>`;
                    row += `<td>${item.sucesso ? 'Sim' : 'Não'}</td>`;
                } else if (type === 'conversao') {
                    row += `<td><input type="checkbox" class="row-select hidden-select" data-id="${item.id}"> ${formatDate(item.dataContato)}</td>`;
                    row += `<td>${item.idCliente}</td>`;
                    row += `<td>${item.tipoAtividade}</td>`;
                    row += `<td>${getOriginName(item.origem)}</td>`;
                    row += `<td>${item.canal}</td>`;
                    row += `<td>${item.descricao || ''}</td>`;
                } else if (type === 'receita') {
                    row += `<td><input type="checkbox" class="row-select hidden-select" data-id="${item.id}"> ${formatDate(item.dataContato)}</td>`;
                    row += `<td>${item.idCliente}</td>`;
                    row += `<td>${getProductName(item.produto)}</td>`;
                    row += `<td>${formatCurrency(item.valor)}</td>`;
                    row += `<td>${item.comissaoTAF}%</td>`;
                    row += `<td>${formatCurrency(item.repasseROA)}</td>`;
                } else if (type === 'atividades') {
                    // scheduled activities may not have id equal to dashboard id but we'll use its own id
                    const isOverdue = new Date(item.data + ' ' + item.hora) < new Date();
                    const statusClass = isOverdue ? 'danger' : '';
                    const statusText = isOverdue ? 'Atrasada' : 'Pendente';
                    row += `<td>${formatDate(item.data)}</td>`;
                    row += `<td>${item.hora}</td>`;
                    row += `<td>${item.idCliente}</td>`;
                    row += `<td>${item.tipo}</td>`;
                    row += `<td><span class="tag" style="color: var(--${statusClass});">${statusText}</span></td>`;
                } else if (type === 'nps') {
                    const daysSinceContact = Math.floor((new Date() - new Date(item.dataContato)) / (1000 * 60 * 60 * 24));
                    row += `<td>${item.idCliente}</td>`;
                    row += `<td>${formatDate(item.dataContato)} (${daysSinceContact} dias atrás)</td>`;
                    row += `<td>${item.tipoAtividade}</td>`;
                    row += `<td><span class="nps-badge">Apto para NPS</span></td>`;
                }
                // Coluna de ações (editar/excluir) para tipos que suportam edição (não NPS ou atividades)
                if (type !== 'nps' && type !== 'atividades') {
                    row += `<td class="actions-cell" style="white-space: nowrap;">
                        <button class="icon-button" onclick="editRecord(${item.id})" title="Editar">
                            <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button class="icon-button" onclick="deleteRecord(${item.id})" title="Excluir">
                            <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>`;
                }
                row += '</tr>';
                rowsHTML += row;
            });
            if (data.length === 0) {
                rowsHTML = `<tr><td colspan="${headers.length + (type !== 'nps' && type !== 'atividades' ? 1 : 0)}" style="text-align: center; padding: 2rem;">Nenhum registro encontrado</td></tr>`;
            }
            tableBody.innerHTML = rowsHTML;
            modal.classList.add('show');
        }
        
        // Filter functions
        function filterCaptacao(produto) {
            const tableBody = document.getElementById('detailTableBody');
            if (!tableBody) return;
            
            let data = dashboardData.filter(item => item.gerouVolume);
            
            if (produto) {
                data = data.filter(item => item.produto === produto);
            }
            
            tableBody.innerHTML = data.map(item => `
                <tr>
                    <td>${formatDate(item.dataContato)}</td>
                    <td>${item.idCliente}</td>
                    <td>${formatCurrency(item.valor)}</td>
                    <td>${getOriginName(item.origem)}</td>
                    <td>${getProductName(item.produto)}</td>
                </tr>
            `).join('');
        }
        
        // Settings Functions
        function showSettings() {
            const userRole = localStorage.getItem('cockpit_user_role');
            if (userRole !== 'Master' && userRole !== 'Admin') {
                const masterPassword = prompt('Digite a senha do usuário Master para acessar as configurações:');
                if (!masterPassword) return;
                
                const masterUser = settings.users.find(u => u.role === 'Master' && atob(u.password) === masterPassword);
                if (!masterUser) {
                    showToast('Senha incorreta!', 'error');
                    return;
                }
            }
            
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.classList.add('show');
                displayUsers();
                displayMetas();
                displayAPISettings();
            }
        }
        
        function toggleSettingsSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) section.classList.toggle('active');
        }
        
        function displayUsers() {
            const userList = document.getElementById('userList');
            if (!userList) return;
            
            userList.innerHTML = settings.users.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>
                        <div class="user-details">
                            <div class="user-name">${user.name}</div>
                            <div class="user-role">${user.role}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="icon-button" onclick="editUser(${user.id})" title="Editar">
                            <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        ${user.role !== 'Master' ? `
                            <button class="icon-button" onclick="removeUser(${user.id})" title="Remover">
                                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function displayMetas() {
            const metasList = document.getElementById('metasList');
            if (!metasList) return;
            
            metasList.innerHTML = `
                <div class="meta-item">
                    <div class="meta-item-header">
                        <span class="meta-item-title">Captação Semestral</span>
                        <span class="meta-item-value">${formatCurrency(settings.metas.captacaoSemestral)}</span>
                    </div>
                </div>
                <div class="meta-item">
                    <div class="meta-item-header">
                        <span class="meta-item-title">Receita Semestral</span>
                        <span class="meta-item-value">${formatCurrency(settings.metas.receitaSemestral)}</span>
                    </div>
                    <div class="meta-details">
                        <div class="meta-detail">
                            <span>COE:</span>
                            <span>${formatCurrency(settings.metas.coe)}</span>
                        </div>
                        <div class="meta-detail">
                            <span>Previdência:</span>
                            <span>${formatCurrency(settings.metas.previdencia)}</span>
                        </div>
                        <div class="meta-detail">
                            <span>Renda Fixa:</span>
                            <span>${formatCurrency(settings.metas.rf)}</span>
                        </div>
                        <div class="meta-detail">
                            <span>Crédito Privado:</span>
                            <span>${formatCurrency(settings.metas.cp)}</span>
                        </div>
                        <div class="meta-detail">
                            <span>Fundos:</span>
                            <span>${formatCurrency(settings.metas.fundos)}</span>
                        </div>
                    </div>
                </div>
                <div class="meta-item">
                    <div class="meta-item-header">
                        <span class="meta-item-title">Contatos por Dia</span>
                        <span class="meta-item-value">${settings.metas.contatosDia}</span>
                    </div>
                </div>
                <div class="meta-item">
                    <div class="meta-item-header">
                        <span class="meta-item-title">Taxa de Conversão Mensal</span>
                        <span class="meta-item-value">${settings.metas.conversaoMensal}%</span>
                    </div>
                </div>
                <div class="meta-item">
                    <div class="meta-item-header">
                        <span class="meta-item-title">Meta NPS</span>
                        <span class="meta-item-value">${settings.metas.nps}</span>
                    </div>
                </div>
            `;
        }
        
        function displayAPISettings() {
            const apiKey = document.getElementById('apiKey');
            const sheetUrl = document.getElementById('sheetUrl');
            const autoSync = document.getElementById('autoSync');
            
            if (apiKey) apiKey.value = settings.api.key || '';
            if (sheetUrl) sheetUrl.value = settings.api.sheetUrl || '';
            if (autoSync) autoSync.checked = settings.api.autoSync || false;
        }
        
        function showMetasForm() {
            const modal = document.getElementById('metasFormModal');
            if (!modal) return;
            
            modal.classList.add('show');
            
            // Preencher com valores atuais
            const inputs = {
                'metaCaptacaoSemestral': settings.metas.captacaoSemestral,
                'metaReceitaSemestral': settings.metas.receitaSemestral,
                'metaCOE': settings.metas.coe,
                'metaPrevidencia': settings.metas.previdencia,
                'metaRF': settings.metas.rf,
                'metaCP': settings.metas.cp,
                'metaFundos': settings.metas.fundos,
                'metaContatosDia': settings.metas.contatosDia,
                'metaConversao': settings.metas.conversaoMensal,
                'metaNPS': settings.metas.nps
            };
            
            Object.entries(inputs).forEach(([id, value]) => {
                const input = document.getElementById(id);
                if (input) {
                    if (id.includes('Conversao')) {
                        input.value = value.toString().replace('.', ',');
                    } else if (typeof value === 'number' && id !== 'metaContatosDia' && id !== 'metaNPS') {
                        input.value = formatCurrency(value).replace('R$ ', '');
                    } else {
                        input.value = value;
                    }
                }
            });
        }
        
        function saveMetas() {
            showLoading();
            
            settings.metas.captacaoSemestral = parseCurrency(document.getElementById('metaCaptacaoSemestral')?.value || '0') || 3000000;
            settings.metas.receitaSemestral = parseCurrency(document.getElementById('metaReceitaSemestral')?.value || '0') || 300000;
            settings.metas.coe = parseCurrency(document.getElementById('metaCOE')?.value || '0') || 50000;
            settings.metas.previdencia = parseCurrency(document.getElementById('metaPrevidencia')?.value || '0') || 100000;
            settings.metas.rf = parseCurrency(document.getElementById('metaRF')?.value || '0') || 80000;
            settings.metas.cp = parseCurrency(document.getElementById('metaCP')?.value || '0') || 40000;
            settings.metas.fundos = parseCurrency(document.getElementById('metaFundos')?.value || '0') || 30000;
            settings.metas.contatosDia = parseInt(document.getElementById('metaContatosDia')?.value || '10') || 10;
            settings.metas.conversaoMensal = parseFloat(document.getElementById('metaConversao')?.value.replace(',', '.') || '15') || 15;
            settings.metas.nps = parseInt(document.getElementById('metaNPS')?.value || '70') || 70;
            
            localStorage.setItem('cockpit_settings', JSON.stringify(settings));
            
            closeModal('metasFormModal');
            displayMetas();
            updateAllKPIs();
            
            hideLoading();
            showToast('Metas atualizadas com sucesso!', 'success');
        }
        
        function addUser() {
            const modal = document.getElementById('userEditModal');
            if (!modal) return;
            
            // Clear form
            const inputs = ['editUserId', 'editUserName', 'editUserEmail', 'editUserPassword'];
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = '';
            });
            
            const roleSelect = document.getElementById('editUserRole');
            if (roleSelect) roleSelect.value = 'User';
            
            modal.classList.add('show');
        }
        
        function editUser(userId) {
            const user = settings.users.find(u => u.id === userId);
            if (!user) return;
            
            const modal = document.getElementById('userEditModal');
            if (!modal) return;
            
            const inputs = {
                'editUserId': user.id,
                'editUserName': user.name,
                'editUserEmail': user.email,
                'editUserPassword': '',
                'editUserRole': user.role
            };
            
            Object.entries(inputs).forEach(([id, value]) => {
                const input = document.getElementById(id);
                if (input) input.value = value;
            });
            
            modal.classList.add('show');
        }
        
        function saveUserEdit() {
            const userId = document.getElementById('editUserId')?.value;
            const name = document.getElementById('editUserName')?.value;
            const email = document.getElementById('editUserEmail')?.value;
            const password = document.getElementById('editUserPassword')?.value;
            const role = document.getElementById('editUserRole')?.value;
            
            if (!name || !email) {
                showToast('Nome e email são obrigatórios.', 'error');
                return;
            }
            
            if (userId) {
                // Edit existing user
                const user = settings.users.find(u => u.id == userId);
                if (user) {
                    user.name = name;
                    user.email = email;
                    if (password) user.password = btoa(password);
                    user.role = role;
                }
            } else {
                // Create new user
                if (!password) {
                    showToast('Senha é obrigatória para novo usuário.', 'error');
                    return;
                }
                
                settings.users.push({
                    id: Date.now(),
                    name,
                    email,
                    password: btoa(password),
                    role
                });
            }
            
            localStorage.setItem('cockpit_settings', JSON.stringify(settings));
            closeModal('userEditModal');
            displayUsers();
            showToast('Usuário salvo com sucesso!', 'success');
        }
        
        function removeUser(userId) {
            if (!confirm('Remover este usuário?')) return;
            
            settings.users = settings.users.filter(u => u.id !== userId);
            localStorage.setItem('cockpit_settings', JSON.stringify(settings));
            displayUsers();
            showToast('Usuário removido com sucesso!', 'success');
        }
        
        function testAPIConnection() {
            const apiKey = document.getElementById('apiKey')?.value;
            const sheetUrl = document.getElementById('sheetUrl')?.value;
            
            if (!apiKey || !sheetUrl) {
                showToast('Preencha a chave da API e a URL da planilha.', 'error');
                return;
            }
            
            showLoading();
            
            // Simulate API test
            setTimeout(() => {
                hideLoading();
                showToast('Conexão testada com sucesso!', 'success');
            }, 1500);
        }
        
        // Chart Functions
        function initChart() {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;
            
            performanceChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Performance ao Longo do Tempo'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateChart() {
            if (!performanceChart) return;
            
            const showCaptacao = document.getElementById('chartCaptacao')?.checked || false;
            const showContatos = document.getElementById('chartContatos')?.checked || false;
            const showConversao = document.getElementById('chartConversao')?.checked || false;
            const showReceita = document.getElementById('chartReceita')?.checked || false;
            
            // Get last 30 days
            const labels = [];
            const captacaoData = [];
            const contatosData = [];
            const conversaoData = [];
            const receitaData = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
                
                const dayData = dashboardData.filter(item => {
                    const itemDate = new Date(item.dataContato);
                    return itemDate.toDateString() === date.toDateString();
                });
                
                if (showCaptacao) {
                    const captacao = dayData
                        .filter(item => item.gerouVolume)
                        .reduce((sum, item) => sum + item.valor, 0);
                    captacaoData.push(captacao);
                }
                
                if (showContatos) {
                    contatosData.push(dayData.length);
                }
                
                if (showConversao) {
                    const conversao = dayData.length > 0 
                        ? (dayData.filter(item => item.gerouVolume).length / dayData.length * 100)
                        : 0;
                    conversaoData.push(conversao);
                }
                
                if (showReceita) {
                    const receita = dayData
                        .filter(item => item.gerouVolume)
                        .reduce((sum, item) => sum + item.repasseROA, 0);
                    receitaData.push(receita);
                }
            }
            
            const datasets = [];
            
            if (showCaptacao) {
                datasets.push({
                    label: 'Captação (R$)',
                    data: captacaoData,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    yAxisID: 'y',
                });
            }
            
            if (showContatos) {
                datasets.push({
                    label: 'Contatos',
                    data: contatosData,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    yAxisID: 'y1',
                });
            }
            
            if (showConversao) {
                datasets.push({
                    label: 'Conversão (%)',
                    data: conversaoData,
                    borderColor: 'rgb(245, 158, 11)',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    yAxisID: 'y2',
                });
            }
            
            if (showReceita) {
                datasets.push({
                    label: 'Receita (R$)',
                    data: receitaData,
                    borderColor: 'rgb(139, 92, 246)',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    yAxisID: 'y',
                });
            }
            
            performanceChart.data.labels = labels;
            performanceChart.data.datasets = datasets;
            
            // Update scales
            const scales = {
                y: {
                    type: 'linear',
                    display: showCaptacao || showReceita,
                    position: 'left',
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                }
            };
            
            if (showContatos) {
                scales.y1 = {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    grid: {
                        drawOnChartArea: false,
                    },
                };
            }
            
            if (showConversao) {
                scales.y2 = {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                };
            }
            
            performanceChart.options.scales = scales;
            performanceChart.update();
        }
        
        function updateChartColors() {
            if (performanceChart && performanceChart.data.datasets.length > 0) {
                updateChart();
            }
        }
        
        // Insights Generation
        function generateInsights() {
            const insightsList = document.getElementById('insightsList');
            if (!insightsList) return;
            
            const candidateInsights = [];
            // Prepare data for calculations
            const last7Days = new Date();
            last7Days.setDate(last7Days.getDate() - 7);
            const recentData = dashboardData.filter(item => new Date(item.dataContato) >= last7Days);
            const recentSuccesses = recentData.filter(item => item.gerouVolume);
            const recentVolume = recentSuccesses.reduce((sum, item) => sum + (item.valor || 0), 0);

            // Candidate 1: Ticket médio dos últimos 7 dias
            if (recentSuccesses.length > 0 && recentVolume > 0) {
                const avgTicket = recentVolume / recentSuccesses.length;
                candidateInsights.push({
                    type: 'positive',
                    text: `Ticket médio dos últimos 7 dias: ${formatCurrency(avgTicket)}`,
                    weight: avgTicket
                });
            }
            // Candidate 2: Taxa de conversão vs meta
            if (recentData.length > 0) {
                const conversionRate = (recentData.filter(item => item.sucesso).length / recentData.length * 100);
                const meta = settings.metas.conversaoMensal;
                const diff = conversionRate - meta;
                candidateInsights.push({
                    type: diff >= 0 ? 'positive' : 'warning',
                    text: diff >= 0 ?
                        `Taxa de conversão acima da meta: ${conversionRate.toFixed(1)}% nos últimos 7 dias` :
                        `Taxa de conversão abaixo da meta: ${conversionRate.toFixed(1)}% (meta: ${meta}%)`,
                    weight: Math.abs(diff)
                });
            }
            // Candidate 3: Dia e horário com mais interações
            const dayCounts = {};
            const hourCounts = {};
            dashboardData.forEach(item => {
                const d = new Date(item.dataContato);
                if (isNaN(d)) return;
                const day = d.getDay();
                dayCounts[day] = (dayCounts[day] || 0) + 1;
                const hour = parseInt((item.horaContato || '00:00').split(':')[0]);
                hourCounts[hour] = (hourCounts[hour] || 0) + 1;
            });
            if (Object.keys(dayCounts).length > 0) {
                const dayNames = ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];
                const topDay = Object.keys(dayCounts).reduce((a,b) => dayCounts[a] > dayCounts[b] ? a : b);
                const topHour = Object.keys(hourCounts).reduce((a,b) => hourCounts[a] > hourCounts[b] ? a : b);
                const interactionsCount = dayCounts[topDay];
                candidateInsights.push({
                    type: 'positive',
                    text: `Maior volume de interações: ${dayNames[topDay]} às ${String(topHour).padStart(2,'0')}h`,
                    weight: interactionsCount
                });
            }
            // Candidate 4: Contatos necessários para meta de receita
            const metaReceita = settings.metas.receitaSemestral || 0;
            const totalReceita = dashboardData.filter(item => item.gerouVolume).reduce((sum, item) => sum + (item.repasseROA || 0), 0);
            const receitas = dashboardData.filter(item => item.gerouVolume).map(item => item.repasseROA || 0);
            const avgReceitaPorContato = receitas.length ? receitas.reduce((a,b) => a + b, 0) / receitas.length : 0;
            const restante = Math.max(0, metaReceita - totalReceita);
            if (restante > 0 && avgReceitaPorContato > 0) {
                const contatosNecessarios = Math.ceil(restante / avgReceitaPorContato);
                candidateInsights.push({
                    type: 'warning',
                    text: `Faltam aproximadamente ${contatosNecessarios} contatos com receita média para atingir a meta de receita`,
                    weight: contatosNecessarios
                });
            }
            // Candidate 5: Produto mais rentável (global)
            const produtoTotais = {};
            dashboardData.filter(item => item.gerouVolume).forEach(item => {
                const prod = getProductName(item.produto);
                produtoTotais[prod] = (produtoTotais[prod] || 0) + (item.repasseROA || 0);
            });
            const topProd = Object.keys(produtoTotais).reduce((a,b) => produtoTotais[a] > produtoTotais[b] ? a : b, null);
            if (topProd) {
                candidateInsights.push({
                    type: 'positive',
                    text: `${topProd} é o produto mais rentável no período selecionado`,
                    weight: produtoTotais[topProd]
                });
            }
            // Candidate 6: Gerente com mais indicações de clientes
            const gerenteCounts = {};
            dashboardData.filter(item => item.origem === 'indicacao_ecossistema').forEach(item => {
                const gerente = item.gerenteIndicador || 'Indefinido';
                gerenteCounts[gerente] = (gerenteCounts[gerente] || 0) + 1;
            });
            const topGerente = Object.keys(gerenteCounts).reduce((a,b) => gerenteCounts[a] > gerenteCounts[b] ? a : b, null);
            if (topGerente && gerenteCounts[topGerente] > 0) {
                candidateInsights.push({
                    type: 'positive',
                    text: `${topGerente} é o gerente com mais indicações de clientes`,
                    weight: gerenteCounts[topGerente]
                });
            }
            // Candidate 7: Pipeline alert (quantidade de oportunidades sem contato)
            const pipelineAlerts = pipelineData.filter(item => {
                const daysSinceContact = calculateBusinessDays(getLastContactForClient(item.idCliente));
                return daysSinceContact > 10;
            });
            if (pipelineAlerts.length > 0) {
                candidateInsights.push({
                    type: 'negative',
                    text: `${pipelineAlerts.length} oportunidades no pipeline precisam de atenção (sem contato há mais de 10 dias)`,
                    weight: pipelineAlerts.length
                });
            }
            // Candidate 8: Atividades atrasadas
            const overdueActivities = scheduledActivities.filter(item => {
                const activityDateTime = new Date(item.data + ' ' + item.hora);
                return activityDateTime < new Date();
            });
            if (overdueActivities.length > 0) {
                candidateInsights.push({
                    type: 'negative',
                    text: `${overdueActivities.length} atividades atrasadas precisam ser realizadas`,
                    weight: overdueActivities.length
                });
            }
            // Sort candidates by weight (descending) and pick top 5
            candidateInsights.sort((a,b) => b.weight - a.weight);
            const finalInsights = candidateInsights.slice(0, 5);
            // Render
            insightsList.innerHTML = finalInsights.map(insight => {
                let iconPath;
                if (insight.type === 'positive') {
                    iconPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
                } else if (insight.type === 'warning') {
                    iconPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
                } else {
                    iconPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
                }
                return `
                    <div class="insight-item">
                        <svg class="insight-icon ${insight.type}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            ${iconPath}
                        </svg>
                        <div class="insight-content">
                            <p class="insight-text">${insight.text}</p>
                        </div>
                    </div>`;
            }).join('');
        }
        
        // File Upload Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }
        
        function setupDragAndDrop() {
            const dropZone = document.body;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
        }
        
        function handleFileUpload(file) {
            if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                file.type === 'application/vnd.ms-excel') {
                
                showLoading();
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Process and add data
                    jsonData.forEach(row => {
                        // Normalize keys helper (remove accents, lowercase)
                        const normalizeKey = key => key.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                        const rowKeys = Object.keys(row);
                        // Determine date from known headers or first column
                        let rawDate = row['Data'] || row['data'] || row['Data Contato'] || row['Data do Contato'];
                        if (rawDate === undefined) {
                            // Fallback to the first key of the row if date header not found
                            if (rowKeys.length > 0) rawDate = row[rowKeys[0]];
                        }
                        let dataContato;
                        if (rawDate !== undefined) {
                            if (typeof rawDate === 'number') {
                                // Excel numeric date conversion (days since 1899-12-30)
                                const jsDate = new Date(Math.round((rawDate - 25569) * 86400 * 1000));
                                dataContato = jsDate.toISOString().split('T')[0];
                            } else {
                                const parsed = new Date(rawDate);
                                if (!isNaN(parsed)) {
                                    dataContato = parsed.toISOString().split('T')[0];
                                } else {
                                    // If not a valid date, use as-is (string)
                                    dataContato = String(rawDate).trim();
                                }
                            }
                        } else {
                            dataContato = new Date().toISOString().split('T')[0];
                        }
                        // Detect time column (Hora, Horário, etc.) and convert numeric times
                        let horaVal = row['Hora'] || row['horário'] || row['Horario'] || row['horario'] || '';
                        if (!horaVal) {
                            rowKeys.forEach(k => {
                                const nk = normalizeKey(k);
                                if (!horaVal && (nk.includes('hora') || nk.includes('horario'))) {
                                    horaVal = row[k];
                                }
                            });
                        }
                        // Convert numeric time (Excel fraction of a day) to HH:MM format
                        if (horaVal && typeof horaVal === 'number') {
                            const totalMinutes = Math.round(horaVal * 24 * 60);
                            const h = Math.floor(totalMinutes / 60);
                            const m = totalMinutes % 60;
                            horaVal = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        } else if (horaVal instanceof Date) {
                            horaVal = horaVal.toTimeString().slice(0, 5);
                        }
                        // Detect product type
                        let produtoVal = row['Produto'] || row['produto'] || '';
                        if (!produtoVal) {
                            rowKeys.forEach(k => {
                                const nk = normalizeKey(k);
                                if (!produtoVal && (nk.includes('produto') || nk.includes('classe') || nk.includes('ativo') || nk.includes('categoria'))) {
                                    produtoVal = row[k];
                                }
                            });
                        }
                        // Detect estratégia (strategy) field
                        let estrategiaVal = row['Estratégia'] || row['Estrategia'] || row['estrategia'] || '';
                        if (!estrategiaVal) {
                            rowKeys.forEach(k => {
                                const nk = normalizeKey(k);
                                if (!estrategiaVal && nk.includes('estrateg')) {
                                    estrategiaVal = row[k];
                                }
                            });
                        }
                        // Detect gerou volume / gerou movimentação financeira
                        let gerouVol = false;
                        if (row['Gerou Volume'] !== undefined) {
                            const val = String(row['Gerou Volume']).toLowerCase();
                            gerouVol = val === 'sim' || val === 'yes' || val === 'verdadeiro' || val === 'true';
                        } else {
                            rowKeys.forEach(k => {
                                const nk = normalizeKey(k);
                                if (nk.includes('gerou') && (nk.includes('volume') || nk.includes('moviment'))) {
                                    const v = String(row[k]).toLowerCase();
                                    gerouVol = v === 'sim' || v === 'yes' || v === 'verdadeiro' || v === 'true';
                                }
                            });
                        }
                        // Detect tipo de atividade
                        let tipoAtv = row['Tipo Atividade'] || row['Tipo de Atividade'] || row['Tipo atividade'] || row['Atividade'] || '';
                        if (!tipoAtv) {
                            rowKeys.forEach(k => {
                                const nk = normalizeKey(k);
                                if (!tipoAtv && nk.includes('tipo') && nk.includes('atividade')) {
                                    tipoAtv = row[k];
                                }
                            });
                        }
                        // Detect canal
                        let canalVal = row['Canal'] || row['canal'] || '';
                        if (!canalVal) {
                            rowKeys.forEach(k => {
                                const nk = normalizeKey(k);
                                if (!canalVal && nk.includes('canal')) {
                                    canalVal = row[k];
                                }
                            });
                        }
                        // Detect origem
                        let origemVal = row['Origem'] || row['origem'] || '';
                        if (!origemVal) {
                            rowKeys.forEach(k => {
                                const nk = normalizeKey(k);
                                if (!origemVal && nk.includes('origem')) {
                                    origemVal = row[k];
                                }
                            });
                        }
                        // Detect gerente indicador
                        let gerenteVal = row['Gerente Indicador'] || row['Gerente'] || '';
                        if (!gerenteVal) {
                            rowKeys.forEach(k => {
                                const nk = normalizeKey(k);
                                if (!gerenteVal && nk.includes('gerente')) {
                                    gerenteVal = row[k];
                                }
                            });
                        }
                        // Detect cliente indicador
                        let clienteIndVal = row['Cliente Indicador'] || row['Cliente Indic'] || '';
                        if (!clienteIndVal) {
                            rowKeys.forEach(k => {
                                const nk = normalizeKey(k);
                                if (!clienteIndVal && nk.includes('cliente') && nk.includes('indic')) {
                                    clienteIndVal = row[k];
                                }
                            });
                        }
                        // Detect ID Cliente
                        let idClienteVal = row['ID Cliente'] || row['ID'] || row['Cliente'] || '';
                        if (!idClienteVal) {
                            rowKeys.forEach(k => {
                                const nk = normalizeKey(k);
                                if (!idClienteVal && (nk.includes('cliente') || nk.includes('id'))) {
                                    idClienteVal = row[k];
                                }
                            });
                        }
                        // Parse numeric values for valor, comissao, repasse
                        const valorRaw = row['Valor'] || row['Volume'] || row['valor'] || row['volume'] || 0;
                        const comissaoRaw = row['Comissão TAF'] || row['Comissao TAF'] || row['comissao'] || 0;
                        const repasseRaw = row['Repasse ROA'] || row['ROA'] || row['repasse'] || 0;
                        const newData = {
                            id: Date.now().toString() + '-' + Math.random().toString(36).substring(2),
                            dataContato: dataContato,
                            horaContato: horaVal || '00:00',
                            idCliente: idClienteVal || '',
                            tipoAtividade: (tipoAtv || 'prospeccao').toString().toLowerCase(),
                            canal: (canalVal || 'ligacao').toString().toLowerCase(),
                            origem: (origemVal || 'base').toString().toLowerCase(),
                            gerenteIndicador: gerenteVal || '',
                            clienteIndicador: clienteIndVal || '',
                            gerouVolume: gerouVol,
                            estrategia: estrategiaVal || '',
                            valor: parseFloat(valorRaw) || 0,
                            produto: produtoVal || '',
                            comissaoTAF: parseFloat(comissaoRaw) || 0,
                            repasseROA: parseFloat(repasseRaw) || 0,
                            descricao: row['Descrição'] || row['Descricao'] || ''
                        };
                        dashboardData.push(newData);
                    });
                    
                    saveLocalData();
                    updateDashboard();
                    
                    hideLoading();
                    showToast(`${jsonData.length} registros importados com sucesso!`, 'success');
                };
                
                reader.readAsBinaryString(file);
            } else {
                showToast('Por favor, envie um arquivo Excel (.xlsx ou .xls)', 'error');
            }
        }
        
        function downloadTemplate() {
            const template = [
                ['Data', 'Hora', 'ID Cliente', 'Tipo Atividade', 'Canal', 'Origem', 'Gerente Indicador', 'Cliente Indicador', 'Gerou Volume', 'Estratégia', 'Valor', 'Produto', 'Comissão TAF', 'Repasse ROA', 'Descrição'],
                ['2024-01-01', '10:00', 'CLI001', 'prospeccao', 'ligacao', 'base', '', '', 'Sim', 'principalidade', '100000', 'rf_bancarios', '0.5', '80', 'Exemplo de atividade']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, 'cockpit_template.xlsx');
        }
        
        // Auto Sync
        let syncInterval = null;
        
        function startAutoSync() {
            if (syncInterval) clearInterval(syncInterval);
            
            syncInterval = setInterval(() => {
                syncWithGoogleSheets();
            }, 5 * 60 * 1000); // 5 minutes
            
            // Initial sync
            syncWithGoogleSheets();
        }
        
        function syncWithGoogleSheets() {
            if (!settings.api.key || !settings.api.sheetUrl) return;
            
            // This would be the actual API call
            console.log('Syncing with Google Sheets...');
            showToast('Sincronizando dados...', 'info');
        }
        
        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        
        function parseCurrency(value) {
            if (typeof value === 'string') {
                return parseFloat(value.replace(/\./g, '').replace(',', '.')) || 0;
            }
            return value || 0;
        }
        
        function formatCurrencyInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (value) {
                value = (parseInt(value) / 100).toFixed(2);
                value = value.replace('.', ',');
                value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                input.value = value;
            }
        }
        
        function formatPercentageInput(input) {
            let value = input.value.replace(/[^\d,]/g, '');
            value = value.replace(',', '.');
            if (value && !isNaN(value)) {
                input.value = parseFloat(value).toFixed(1).replace('.', ',');
            }
        }
        
        function getOriginName(origin) {
            const names = {
                'base': 'Base',
                'indicacao_base': 'Indicação Base',
                'indicacao_ecossistema': 'Indicação Ecossistema'
            };
            return names[origin] || origin;
        }
        
        function getStrategyName(strategy) {
            const names = {
                'principalidade': 'Principalidade',
                'transacionalidade': 'Transacionalidade',
                'saldo_conta': 'Saldo em Conta',
                'previdencia_stvm': 'Previdência/STVM'
            };
            return names[strategy] || strategy;
        }
        
        function getProductName(product) {
            const names = {
                'rf_bancarios': 'Renda Fixa Bancários',
                'rf_bancarios_toro': 'RF Bancários Toro',
                'credito_privado': 'Crédito Privado',
                'credito_privado_toro': 'Crédito Privado Toro',
                'fundos': 'Fundos de Investimentos',
                'coe': 'COE',
                'previdencia': 'Previdência',
                'renda_variavel': 'Renda Variável'
            };
            return names[product] || product;
        }

    /* === Detail Selection and Filter Functions === */
    function toggleSelectionMode() {
        selectionMode = !selectionMode;
        // Toggle visibility of row checkboxes and action buttons
        const checkboxes = document.querySelectorAll('.row-select');
        checkboxes.forEach(cb => {
            if (selectionMode) {
                cb.classList.remove('hidden-select');
            } else {
                cb.classList.add('hidden-select');
                cb.checked = false;
            }
        });
        const deleteBtn = document.getElementById('deleteSelectedBtn');
        const dupBtn = document.getElementById('duplicateSelectedBtn');
        if (deleteBtn) deleteBtn.classList.toggle('hidden', !selectionMode);
        if (dupBtn) dupBtn.classList.toggle('hidden', !selectionMode);
    }

    /**
     * Preenche o formulário de atividade com os dados do registro selecionado
     * e abre o modal para edição.
     * @param {number} id Identificador do registro
     */
    function editRecord(id) {
        const record = dashboardData.find(item => item.id === id);
        if (!record) return;
        editingId = id;
        // Preencher campos do formulário de atividade
        const dataContato = document.getElementById('dataContato');
        const horaContato = document.getElementById('horaContato');
        const idCliente = document.getElementById('idCliente');
        const tipoAtividade = document.getElementById('tipoAtividade');
        const canal = document.getElementById('canal');
        const origem = document.getElementById('origem');
        const gerenteIndicador = document.getElementById('gerenteIndicador');
        const clienteIndicador = document.getElementById('clienteIndicador');
        const gerouVolume = document.getElementById('gerouVolume');
        const estrategia = document.getElementById('estrategia');
        const valor = document.getElementById('valor');
        const produto = document.getElementById('produto');
        const comissaoTAF = document.getElementById('comissaoTAF');
        const repasseROA = document.getElementById('repasseROA');
        const descricao = document.getElementById('descricao');
        const atividadeSucesso = document.getElementById('atividadeSucesso');

        if (dataContato) dataContato.value = record.dataContato;
        if (horaContato) horaContato.value = record.horaContato;
        if (idCliente) idCliente.value = record.idCliente;
        if (tipoAtividade) tipoAtividade.value = record.tipoAtividade;
        if (canal) canal.value = record.canal;
        if (origem) origem.value = record.origem;
        if (gerenteIndicador) gerenteIndicador.value = record.gerenteIndicador || '';
        if (clienteIndicador) clienteIndicador.value = record.clienteIndicador || '';
        if (gerouVolume) gerouVolume.checked = !!record.gerouVolume;
        if (estrategia) estrategia.value = record.estrategia || '';
        if (valor) valor.value = record.valor ? formatCurrency(record.valor).replace('R$ ', '').replace('.', ',') : '';
        if (produto) produto.value = record.produto || '';
        if (comissaoTAF) comissaoTAF.value = record.comissaoTAF !== undefined ? record.comissaoTAF.toString().replace('.', ',') : '';
        if (repasseROA) repasseROA.value = record.repasseROA ? formatCurrency(record.repasseROA).replace('R$ ', '').replace('.', ',') : '';
        if (descricao) descricao.value = record.descricao || '';
        if (atividadeSucesso) atividadeSucesso.checked = !!record.sucesso;

        toggleVolumeFields();
        checkOrigemFields();
        // Mostrar modal de atividade
        closeModal('detailModal');
        const modal = document.getElementById('activityModal');
        if (modal) modal.classList.add('show');
    }

    /**
     * Remove permanentemente um registro da base após confirmação.
     * @param {number} id Identificador do registro
     */
    function deleteRecord(id) {
        if (!confirm('Deseja realmente excluir este registro?')) return;
        dashboardData = dashboardData.filter(item => item.id !== id);
        saveLocalData();
        // Atualiza KPIs e detalhes
        updateDashboard();
        if (currentDetailType) {
            showDetails(currentDetailType);
        }
        showToast('Registro excluído com sucesso.', 'success');
    }

    function deleteSelectedRecords() {
        // Collect selected IDs as strings (ids are stored as strings)
        const selected = Array.from(document.querySelectorAll('.row-select')).filter(cb => cb.checked).map(cb => cb.getAttribute('data-id'));
        if (selected.length === 0) {
            showToast('Nenhum registro selecionado.', 'warning');
            return;
        }
        if (!confirm('Deseja realmente excluir os registros selecionados?')) return;
        selected.forEach(id => {
            dashboardData = dashboardData.filter(item => item.id !== id);
        });
        saveLocalData();
        updateDashboard();
        // Refresh details modal if open
        if (currentDetailType) {
            showDetails(currentDetailType);
        }
        showToast('Registros excluídos com sucesso.', 'success');
    }

    function duplicateSelectedRecords() {
        // Collect selected IDs as strings
        const selected = Array.from(document.querySelectorAll('.row-select')).filter(cb => cb.checked).map(cb => cb.getAttribute('data-id'));
        if (selected.length === 0) {
            showToast('Nenhum registro selecionado.', 'warning');
            return;
        }
        selected.forEach(id => {
            const record = dashboardData.find(item => item.id === id);
            if (record) {
                const copy = Object.assign({}, record, { id: Date.now().toString() + '-' + Math.random().toString(36).substring(2) });
                dashboardData.push(copy);
            }
        });
        saveLocalData();
        updateDashboard();
        if (currentDetailType) {
            showDetails(currentDetailType);
        }
        showToast('Registros duplicados com sucesso.', 'success');
    }

    /**
     * Manipula o clique nos cartões de KPI. Abre os detalhes apenas quando o clique
     * não ocorre em elementos de controle como o seletor de período, botão de expansão
     * ou botão de alternância de detalhes. Caso contrário, apenas executa a ação do
     * respectivo controle.
     * @param {Event} event Evento de clique
     * @param {string} type Tipo de card cujos detalhes devem ser mostrados
     */
    function onCardClick(event, type) {
        // Não abra detalhes se o clique for dentro de elementos de controle (calendário ou botão de expansão)
        if (event.target.closest('.period-selector') || event.target.closest('.expand-button')) {
            return;
        }
        showDetails(type);
    }

    // Current filter dropdown element (used to close when clicking elsewhere)
    let currentFilterMenu = null;

    // Show a contextual filter menu for the specified column index
    function showFilterMenu(event, colIndex) {
        event.stopPropagation();
        // Remove any existing filter menu
        if (currentFilterMenu) {
            currentFilterMenu.remove();
            currentFilterMenu = null;
        }
        // Create the menu container
        const menu = document.createElement('div');
        menu.className = 'filter-dropdown';
        // Determine column type and name
        const colName = currentHeaders[colIndex] || '';
        const numericCols = ['Volume','Valor','ROA','Comissão TAF'];
        const dateCols = ['Data','Último Contato'];
        const normalized = colName.toLowerCase();
        // Build menu content
        // Header title
        const title = document.createElement('div');
        title.className = 'filter-title';
        title.textContent = `Filtrar ${colName}`;
        menu.appendChild(title);
        const isNumeric = numericCols.map(c => c.toLowerCase()).includes(normalized);
        const isDate = dateCols.map(c => c.toLowerCase()).includes(normalized);
        // If the column is numeric or date, provide sorting options
        if (isNumeric || isDate) {
            const optAsc = document.createElement('div');
            optAsc.className = 'filter-option';
            optAsc.textContent = 'Ordenar do menor para o maior';
            optAsc.onclick = function() {
                sortDetailTable(colIndex, 'asc', isNumeric, isDate);
                menu.remove();
                currentFilterMenu = null;
            };
            menu.appendChild(optAsc);
            const optDesc = document.createElement('div');
            optDesc.className = 'filter-option';
            optDesc.textContent = 'Ordenar do maior para o menor';
            optDesc.onclick = function() {
                sortDetailTable(colIndex, 'desc', isNumeric, isDate);
                menu.remove();
                currentFilterMenu = null;
            };
            menu.appendChild(optDesc);
            const divider = document.createElement('div');
            divider.style.borderTop = '1px solid var(--border)';
            divider.style.margin = '0.25rem 0';
            menu.appendChild(divider);
        }
        // Special handling for ID columns: provide a search box instead of listing all IDs
        if (normalized.includes('id')) {
            const searchContainer = document.createElement('div');
            searchContainer.style.padding = '0.5rem 1rem';
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Pesquisar ID';
            input.style.width = '100%';
            input.style.padding = '0.25rem 0.5rem';
            input.style.border = '1px solid var(--border)';
            input.style.borderRadius = '4px';
            input.style.background = 'var(--surface)';
            input.style.color = 'var(--text-primary)';
            input.addEventListener('input', function() {
                const val = input.value.trim().toLowerCase();
                if (val) {
                    detailFilters[colIndex] = val;
                } else {
                    delete detailFilters[colIndex];
                }
                applyDetailFilters();
            });
            searchContainer.appendChild(input);
            menu.appendChild(searchContainer);
            // Adicionar botão para limpar filtro
            const clear = document.createElement('div');
            clear.className = 'filter-option';
            clear.textContent = 'Limpar Filtro';
            clear.onclick = function() {
                delete detailFilters[colIndex];
                applyDetailFilters();
                menu.remove();
                currentFilterMenu = null;
            };
            menu.appendChild(clear);
        } else if (!isNumeric && !isDate) {
            // For other text columns, list unique values as selectable options
            const valuesSet = new Set();
            const rows = Array.from(document.querySelectorAll('#detailTableBody tr'));
            rows.forEach(row => {
                const cell = row.children[colIndex];
                if (cell) {
                    const text = cell.textContent.trim();
                    if (text !== '') valuesSet.add(text);
                }
            });
            let values = Array.from(valuesSet);
            // Sort values naturally: numeric values ascend numerically; others alphabetically
            if (values.every(v => /^\d+(?:[.,]\d+)?$/.test(v.replace(/[^0-9,.-]/g, '')))) {
                values.sort((a, b) => {
                    const numA = parseFloat(a.replace(/[^0-9,.-]/g, '').replace('.', '').replace(',', '.'));
                    const numB = parseFloat(b.replace(/[^0-9,.-]/g, '').replace('.', '').replace(',', '.'));
                    return numA - numB;
                });
            } else {
                values.sort((a, b) => a.localeCompare(b));
            }
            // Option to clear filter
            const allOpt = document.createElement('div');
            allOpt.className = 'filter-option';
            allOpt.textContent = 'Todos';
            allOpt.onclick = function() {
                delete detailFilters[colIndex];
                applyDetailFilters();
                menu.remove();
                currentFilterMenu = null;
            };
            menu.appendChild(allOpt);
            const maxOptions = 50;
            values.slice(0, maxOptions).forEach(val => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                option.textContent = val;
                option.onclick = function() {
                    detailFilters[colIndex] = val.toLowerCase();
                    applyDetailFilters();
                    menu.remove();
                    currentFilterMenu = null;
                };
                menu.appendChild(option);
            });
            if (values.length > maxOptions) {
                const more = document.createElement('div');
                more.className = 'filter-option';
                more.textContent = '...';
                more.style.cursor = 'default';
                menu.appendChild(more);
            }
        }
        // Append menu to body and position near the clicked icon
        document.body.appendChild(menu);
        const rect = event.target.getBoundingClientRect();
        menu.style.top = `${window.scrollY + rect.bottom + 4}px`;
        // Align to the right side of the icon if space permits, otherwise left align
        const menuWidth = 180;
        let leftPos = window.scrollX + rect.left;
        // Ensure the dropdown doesn't overflow off the right edge of the viewport
        if (leftPos + menuWidth > window.innerWidth) {
            leftPos = window.innerWidth - menuWidth - 10;
        }
        menu.style.left = `${leftPos}px`;
        currentFilterMenu = menu;
    }
    // Apply search filters to detail table rows
    function applyDetailFilters() {
        const rows = document.querySelectorAll('#detailTableBody tr');
        rows.forEach(row => {
            let visible = true;
            Object.keys(detailFilters).forEach(colIdx => {
                const idx = parseInt(colIdx);
                const cell = row.children[idx];
                if (cell) {
                    const text = cell.textContent.trim().toLowerCase();
                    const filterVal = detailFilters[colIdx];
                    if (!text.includes(filterVal)) {
                        visible = false;
                    }
                }
            });
            row.style.display = visible ? '' : 'none';
        });
    }
    // Sort the detail table by a given column (numeric, textual, or date)
    function sortDetailTable(colIndex, order = 'asc', numeric = false, isDate = false) {
        const tbody = document.getElementById('detailTableBody');
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
            const aCell = a.children[colIndex];
            const bCell = b.children[colIndex];
            if (!aCell || !bCell) return 0;
            let aVal = aCell.textContent.trim();
            let bVal = bCell.textContent.trim();
            if (numeric) {
                // Remove currency symbols, commas and periods and parse as float
                const parseNumber = (val) => {
                    const num = val.replace(/[^0-9,.-]/g, '').replace('.', '').replace(',', '.');
                    return parseFloat(num) || 0;
                };
                aVal = parseNumber(aVal);
                bVal = parseNumber(bVal);
            } else if (isDate) {
                aVal = new Date(aVal);
                bVal = new Date(bVal);
            } else {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }
            if (aVal < bVal) return order === 'asc' ? -1 : 1;
            if (aVal > bVal) return order === 'asc' ? 1 : -1;
            return 0;
        });
        // Re-append sorted rows
        rows.forEach(row => tbody.appendChild(row));
    }
    </script>
    <!-- Period Selection Modal -->
    <div class="period-modal" id="periodModal" onclick="if(event.target.id==='periodModal') closePeriodModal()">
        <div class="modal-content" onclick="event.stopPropagation();">
            <h3>Selecionar Período</h3>
            <div class="period-options">
                <button class="period-option-btn" onclick="selectPeriodFromModal('day')">Dia</button>
                <button class="period-option-btn" onclick="selectPeriodFromModal('week')">Semana</button>
                <button class="period-option-btn" onclick="selectPeriodFromModal('month')">Mês</button>
                <button class="period-option-btn" onclick="selectPeriodFromModal('semester')">Semestre</button>
            </div>
            <button class="period-option-btn" style="margin-top: 0.75rem;" onclick="closePeriodModal()">Cancelar</button>
        </div>
    </div>
</body>
</html>
                